<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Installments • Client edit (v4.2)</title>
  <style>
    *{box-sizing:border-box}
    :root{--bg:#0b0d12;--card:#0f1420;--line:#1c2233;--muted:#9fb0d0;--ink:#e7ebf3}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px;font-size:24px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .col-4{grid-column:span 4}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{color:var(--muted);font-size:13px}
    input[type="text"],input[type="number"],input[type="range"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #26304a;background:#111828;color:var(--ink)}
    input[type="range"]{padding:0;height:32px}
    .pill{padding:6px 10px;border-radius:999px;background:#10192a;border:1px solid #22304a;font-size:12px}
    .badge{background:#132039;border:1px solid #243353;padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);border:0;margin:10px 0}
    .btn{appearance:none;border:1px solid #2a3756;background:#132039;color:#dfe7ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.warn{background:#2a1420;border-color:#513042;color:#ffd8de}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #202a42;text-align:right;font-variant-numeric:tabular-nums}
    th:first-child,td:first-child{text-align:left}
    .scroll{overflow:auto;max-height:48vh}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
    .kpi{background:#0f1420;border:1px solid #1c2233;border-radius:10px;padding:10px 12px}
    .kpi .v{font-size:18px;font-weight:700}
    .note{font-size:12px;color:#94a6c7}
    .banner{background:#12233e;border:1px dashed #2b4d86;padding:8px 12px;border-radius:10px;color:#bcd3ff}
    @media print{body{background:white;color:black}.card{border:1px solid #ccc}.btn{display:none}.scroll{max-height:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Калькулятор рассрочки • Client‑Edit (v4.2)</h1>
    <div id="root"></div>
  </div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useEffect,useMemo,useState} = React

    // --- utils ---
    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v))
    const fmtMoney = (n, currency='USD') =>
      new Intl.NumberFormat('en-US',{style:'currency',currency,maximumFractionDigits:2}).format(n??0)

    // hash helpers: #s=<base64>&view=client
    const readHashParams = () => {
      const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash
      const sp = new URLSearchParams(h)
      return { s: sp.get('s'), view: sp.get('view') }
    }
    const encodeStateToUrl = (state, {view}={}) => {
      try{
        const s = btoa(unescape(encodeURIComponent(JSON.stringify(state))))
        const url = new URL(location.href)
        const sp = new URLSearchParams()
        sp.set('s', s)
        if(view) sp.set('view', view)
        url.hash = sp.toString()
        return url.toString()
      }catch{ return '' }
    }
    const decodeStateFromUrl = () => {
      try{
        const {s, view} = readHashParams()
        if(!s) return null
        const obj = JSON.parse(decodeURIComponent(escape(atob(s))))
        return { state: obj, view }
      }catch{ return null }
    }

    function App(){
      // отображение (валюта для клиента оставим USD фиксированно — чтобы не усложнять)
      const currency = 'USD'

      // глобальные параметры (используются, но в клиентском UI не показываются)
      const [handoverMonth,setHandoverMonth] = useState(12)
      const [months,setMonths] = useState(12)              // дефолт
      const [monthlyRatePct,setMonthlyRatePct] = useState(8.33)

      // этапы до ключей (структура общая; суммы масштабируются под % виллы)
      const [stages,setStages] = useState([
        {id:1,label:'Договор', pct:30, month:0},
        {id:2,label:'50% готовности', pct:30, month:6},
        {id:3,label:'70% готовности', pct:20, month:9},
        {id:4,label:'90% готовности', pct:15, month:11},
        {id:5,label:'Ключи', pct:5, month:12},
      ])

      // виллы: для клиента — можно менять цену, % до ключей, и первый платёж после ключей
      const [villas,setVillas] = useState([
        {id:1,name:'Enso 2BR', area:100, ppsm:2500, override:true, base:250000, prePct:70,
         ownTerms:false, months:null, monthlyRatePct:null, firstPostUSD:0},
      ])

      // флаги режима
      const [isClient,setIsClient] = useState(false)

      // восстановление состояния
      useEffect(()=>{
        const fromUrl = decodeStateFromUrl()
        const saved = fromUrl?.state || JSON.parse(localStorage.getItem('installment_v42')||'null')
        if(saved){
          try{
            if(typeof saved.handoverMonth==='number') setHandoverMonth(saved.handoverMonth)
            if(typeof saved.months==='number') setMonths(saved.months)
            if(typeof saved.monthlyRatePct==='number') setMonthlyRatePct(saved.monthlyRatePct)
            if(Array.isArray(saved.stages)) setStages(saved.stages)
            if(Array.isArray(saved.villas) && saved.villas.length) {
              // если нет поля firstPostUSD у старых сохранений — добавим
              setVillas(saved.villas.map(v=> ({ firstPostUSD:0, ...v })))
            }
          }catch{}
        }
        if(fromUrl?.view === 'client') setIsClient(true)
      },[])
      useEffect(()=>{
        const state = {handoverMonth,months,monthlyRatePct,stages,villas}
        localStorage.setItem('installment_v42', JSON.stringify(state))
      },[handoverMonth,months,monthlyRatePct,stages,villas])

      // расчёты
      const stagesSumPct = useMemo(()=> stages.reduce((s,x)=>s+(+x.pct||0),0), [stages])

      const villaCalcs = useMemo(()=>{
        return villas.map(v=>{
          const base = v.override ? (v.base||0) : (v.area * v.ppsm)

          // масштабируем этапы под выбранный % «до ключей»
          const k = stagesSumPct===0 ? 0 : (v.prePct||0)/stagesSumPct
          const preSchedule = stages.map(s=>({
            month: clamp(Math.round(+s.month||0),0,handoverMonth),
            label:s.label,
            amountUSD: base * (((+s.pct||0)*k)/100),
          })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month)
          const preTotal = preSchedule.reduce((s,r)=>s+r.amountUSD,0)

          // остаток после ключей до "первого платежа клиента"
          const afterAmountRaw = Math.max(0, base - preTotal)

          // применяем первый платёж клиента после ключей — он идёт сразу в погашение основного долга
          const firstPostUSD = Math.max(0, +v.firstPostUSD||0)
          const afterAmount = Math.max(0, afterAmountRaw - firstPostUSD)

          // условия post‑handover (индивидуальные или глобальные)
          const vMonths = v.ownTerms && v.months ? v.months : months
          const vRate   = (v.ownTerms && v.monthlyRatePct!=null) ? (v.monthlyRatePct/100) : (monthlyRatePct/100)

          // график: равные доли основного на оставшиеся vMonths, проценты скрываем в клиентском UI
          const postRows=[]
          let bal = afterAmount
          const principal = vMonths>0 ? afterAmount / vMonths : 0
          for(let i=1;i<=vMonths;i++){
            // проценты считаем, но не показываем: interest = bal * vRate
            const interest = bal * vRate
            const payment = principal + interest
            postRows.push({month: handoverMonth + i, label:`Месяц ${i}`, principalUSD:principal, interestUSD:interest, paymentUSD:payment, balanceAfterUSD: Math.max(0, bal - principal)})
            bal -= principal
          }

          // итоговая цена = база + сумма процентов (хотя проценты скрыты визуально, итог учитывает их)
          const totalInterest = postRows.reduce((s,r)=>s+r.interestUSD,0)
          const finalPrice = base + totalInterest

          return { v, base, preSchedule, preTotal, firstPostUSD, afterAmountRaw, afterAmount, postRows, totalInterest, finalPrice, months:vMonths }
        })
      },[villas, stages, stagesSumPct, handoverMonth, months, monthlyRatePct])

      // агрегаты проекта
      const totals = useMemo(()=>({
        baseUSD: villaCalcs.reduce((s,x)=>s+x.base,0),
        preUSD: villaCalcs.reduce((s,x)=>s+x.preTotal,0),
        afterUSD: villaCalcs.reduce((s,x)=>s+x.afterAmount,0),
        finalUSD: villaCalcs.reduce((s,x)=>s+x.finalPrice,0),
      }),[villaCalcs])

      // обновления вилл
      const updateVilla = (id, patch)=> setVillas(prev=> prev.map(v=> v.id===id? {...v, ...patch}: v))
      const addVilla = ()=> setVillas(prev=>[...prev,{id:(prev.at(-1)?.id||0)+1,name:'Новая вилла',area:100,ppsm:2500,override:true,base:250000,prePct:70,ownTerms:false,months:null,monthlyRatePct:null,firstPostUSD:0}])
      const removeVilla = (id)=> setVillas(prev=> prev.filter(v=> v.id!==id))

      // ссылки
      const shareEditor = async ()=>{
        const state = {handoverMonth,months,monthlyRatePct,stages,villas}
        const url = encodeStateToUrl(state, {view:null})
        await navigator.clipboard.writeText(url); alert('Ссылка (редактор) скопирована')
      }
      const shareClient = async ()=>{
        const state = {handoverMonth,months,monthlyRatePct,stages,villas}
        const url = encodeStateToUrl(state, {view:'client'})
        await navigator.clipboard.writeText(url); alert('Ссылка для клиента скопирована')
      }

      return (
        <div className="grid">
          <div className="card col-4">
            <div className="banner" style={{marginBottom:10}}>
              Клиентский режим: ставка и сумма процентов скрыты.
              Клиент может менять цену виллы, % «до ключей» и первый платёж после ключей.
            </div>

            <div className="field">
              <label>Месяц получения ключей</label>
              <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))} />
            </div>

            <div className="row">
              <div className="field" style={{flex:1}}>
                <label>Срок post‑handover (мес)</label>
                <input type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
              </div>
              <div className="field" style={{flex:1}}>
                <label>Скрытая ставка (%/мес)</label>
                <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                <div className="note">Клиент её не видит — влияет только на итоговую цену.</div>
              </div>
            </div>

            <div className="hr"></div>

            <div className="row">
              <button className="btn" onClick={shareEditor}>Поделиться (редактор)</button>
              <button className="btn" onClick={shareClient}>Поделиться (клиенту)</button>
            </div>
          </div>

          <div className="card col-8">
            {/* KPI для клиента: только 3 метрики */}
            <div className="kpis">
              <KPI label="Итоговая цена (проект)" value={fmtMoney(totals.finalUSD, currency)}/>
              <KPI label="Оплата до ключей (проект)" value={fmtMoney(totals.preUSD, currency)}/>
              <KPI label="Остаток после ключей (проект)" value={fmtMoney(totals.afterUSD, currency)}/>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Виллы (клиент может редактировать цену, % до ключей и первый платёж)</h3>
            <div className="scroll" style={{maxHeight:'34vh'}}>
              <table>
                <thead>
                  <tr>
                    <th>Название</th><th>м²</th><th>$ / м²</th><th>Цена (USD)</th><th>До ключей, %</th><th>Первый платёж после ключей (USD)</th><th>Удалить</th>
                  </tr>
                </thead>
                <tbody>
                  {villaCalcs.map(vc=>(
                    <tr key={vc.v.id}>
                      <td style={{textAlign:'left'}}>
                        <input type="text" value={vc.v.name} onChange={e=>updateVilla(vc.v.id,{name:e.target.value})}/>
                      </td>
                      <td><input type="number" min="1" step="0.1" value={vc.v.area} onChange={e=>updateVilla(vc.v.id,{area:clamp(parseFloat(e.target.value||0),1,100000), override:false})}/></td>
                      <td><input type="number" min="0" step="1" value={vc.v.ppsm} onChange={e=>updateVilla(vc.v.id,{ppsm:clamp(parseFloat(e.target.value||0),0,1e9), override:false})}/></td>
                      <td>
                        <label className="pill" style={{display:'inline-flex',gap:6,alignItems:'center',marginBottom:6}}>
                          <input type="checkbox" checked={vc.v.override} onChange={e=>updateVilla(vc.v.id,{override:e.target.checked})}/>
                          вручную
                        </label>
                        <input type="number" min="0" step="1" value={vc.v.override ? vc.v.base : Math.round(vc.v.area*vc.v.ppsm)} onChange={e=>updateVilla(vc.v.id,{base:clamp(parseFloat(e.target.value||0),0,1e12), override:true})}/>
                      </td>
                      <td>
                        <input type="range" min="0" max="100" step="1" value={vc.v.prePct} onChange={e=>updateVilla(vc.v.id,{prePct:parseInt(e.target.value,10)})}/>
                        <div className="pill" style={{display:'inline-block',marginTop:6}}>{vc.v.prePct}%</div>
                      </td>
                      <td>
                        <input type="number" min="0" step="1" value={vc.v.firstPostUSD} onChange={e=>updateVilla(vc.v.id,{firstPostUSD:clamp(parseFloat(e.target.value||0),0,1e12)})}/>
                        <div className="note">Сразу уменьшит остаток после ключей.</div>
                      </td>
                      <td><button className="btn warn" onClick={()=>removeVilla(vc.v.id)}>✕</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="row" style={{marginTop:8}}>
              <button className="btn" onClick={addVilla}>Добавить виллу</button>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Post‑handover (помесячно, без показа процентов)</h3>
            <div className="scroll">
              <table>
                <thead>
                  <tr>
                    <th>Вилла</th><th>Месяц</th><th>Основной долг (USD)</th><th>Платёж (USD)</th><th>Остаток (USD)</th>
                  </tr>
                </thead>
                <tbody>
                  {villaCalcs.flatMap(vc=> vc.postRows.map(r=>(
                    <tr key={`${vc.v.id}-${r.month}`}>
                      <td style={{textAlign:'left'}}>{vc.v.name}</td>
                      <td>{r.month}</td>
                      <td>{fmtMoney(r.principalUSD, currency)}</td>
                      <td>{fmtMoney(r.paymentUSD, currency)}</td>
                      <td>{fmtMoney(r.balanceAfterUSD, currency)}</td>
                    </tr>
                  )))}
                </tbody>
              </table>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Итоги (для клиента)</h3>
            <div className="kpis">
              <KPI label="Итоговая цена (проект)" value={fmtMoney(totals.finalUSD, currency)}/>
              <KPI label="Оплата до ключей (проект)" value={fmtMoney(totals.preUSD, currency)}/>
              <KPI label="Остаток после ключей (проект)" value={fmtMoney(totals.afterUSD, currency)}/>
            </div>
          </div>
        </div>
      )
    }

    function KPI({label,value}) {
      return (
        <div className="kpi">
          <div className="muted">{label}</div>
          <div className="v">{value}</div>
        </div>
      )
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>)
  </script>
</body>
</html>

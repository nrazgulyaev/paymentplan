<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arconique / Инвестиционный калькулятор</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    *{box-sizing:border-box}
    
    :root{
      /* Современная цветовая палитра */
      --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card: rgba(255,255,255,0.03);
      --card-hover: rgba(255,255,255,0.08);
      --card-active: rgba(255,255,255,0.12);
      --line: rgba(255,255,255,0.08);
      --line-hover: rgba(255,255,255,0.15);
      
      --muted: #94a3b8;
      --ink: #f8fafc;
      --ink-secondary: #cbd5e1;
      
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --success-hover: #059669;
      --warning: #f59e0b;
      --warning-hover: #d97706;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      
      --accent: #8b5cf6;
      --accent-hover: #7c3aed;
      
      --radius: 16px;
      --radius-sm: 8px;
      --radius-lg: 24px;
      
      /* Современные тени */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      
      /* Анимации */
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      
      /* Отступы и размеры */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      
      /* Высота блоков */
      --block-min-height: 200px;
      --block-max-height: 600px;
      
      /* Z-index слои */
      --z-base: 1;
      --z-card: 10;
      --z-modal: 1000;
      --z-tooltip: 1100;
    }
    
    /* Базовые стили */
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      min-height:100vh;
      overflow-x:hidden;
      line-height:1.6;
    }
    
    /* Современные анимации для элементов */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-8px) rotate(0.5deg); }
      66% { transform: translateY(4px) rotate(-0.5deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }
    
    /* Современные компоненты */
    .wrap{
      max-width:1400px;
      margin:24px auto;
      padding:0 16px;
      animation: fadeInUp 0.8s ease-out;
    }
    
    h1{
      margin:0 0 16px;
      font-size:clamp(1.5rem, 4vw, 2.5rem);
      font-weight:700;
      background:linear-gradient(135deg, var(--ink) 0%, var(--ink-secondary) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      text-align:center;
    }
    
    /* Современная сетка */
    .grid{
      display:grid;
      grid-template-columns:420px 1fr;
      gap:24px;
      animation: fadeInScale 0.6s ease-out 0.2s both;
    }
    
    @media (max-width: 1023px) {
      .grid { 
        grid-template-columns: 1fr; 
        gap: 16px;
      }
    }

    /* Современные карточки */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:24px;
      backdrop-filter:blur(20px);
      box-shadow:var(--shadow);
      transition:all var(--transition-normal);
      position:relative;
      overflow:hidden;
      margin-bottom: var(--spacing-lg);
    }
    
    .card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:1px;
      background:linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity:0;
      transition:opacity var(--transition-normal);
    }
    
    .card:hover{
      background:var(--card-hover);
      border-color:var(--line-hover);
      transform:translateY(-4px);
      box-shadow:var(--shadow-lg);
    }
    
    .card:hover::before{
      opacity:1;
    }
    
    .card:active{
      background:var(--card-active);
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }
    
    /* Современные заголовки карточек */
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:1px solid var(--line);
    }
    
    .card-header h3{
      margin:0;
      font-size:1.25rem;
      font-weight:600;
      color:var(--ink);
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .card-header h3::before{
      content:'';
      width:4px;
      height:20px;
      background:linear-gradient(180deg, var(--primary), var(--accent));
      border-radius:2px;
    }
    
    .card-actions{
      display:flex;
      gap:8px;
    }
    
    /* Современные кнопки */
    .btn{
      appearance:none;
      border:none;
      background:var(--card);
      color:var(--ink);
      padding:12px 20px;
      border-radius:var(--radius-sm);
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all var(--transition-fast);
      border:1px solid var(--line);
      position:relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      white-space: nowrap;
    }
    
    .btn::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition:left var(--transition-slow);
    }
    
    .btn:hover::before{
      left:100%;
    }
    
    .btn:hover{
      background:var(--card-hover);
      border-color:var(--line-hover);
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }
    
    .btn:active{
      transform:translateY(0);
      box-shadow:var(--shadow-sm);
    }
    
    .btn.primary{
      background:var(--primary);
      border-color:var(--primary);
      color:white;
    }
    
    .btn.primary:hover{
      background:var(--primary-hover);
      border-color:var(--primary-hover);
    }
    
    .btn.success{
      background:var(--success);
      border-color:var(--success);
      color:white;
    }
    
    .btn.success:hover{
      background:var(--success-hover);
      border-color:var(--success-hover);
    }
    
    .btn.warning{
      background:var(--warning);
      border-color:var(--warning);
      color:white;
    }
    
    .btn.warning:hover{
      background:var(--warning-hover);
      border-color:var(--warning-hover);
    }
    
    .btn.danger{
      background:var(--danger);
      border-color:var(--danger);
      color:white;
    }
    
    .btn.danger:hover{
      background:var(--danger-hover);
      border-color:var(--danger-hover);
    }
    
    .btn.icon{
      padding:10px;
      border-radius:50%;
      min-width:40px;
      justify-content:center;
    }
    
    .btn.compact{
      padding:8px 16px;
      font-size:13px;
    }
    
    /* Современные поля ввода */
    .field{
      display:grid;
      gap:8px;
      margin-bottom:20px;
    }
    
    .field label{
      color:var(--muted);
      font-size:13px;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    .field label::before{
      content:'';
      width:3px;
      height:3px;
      background:var(--accent);
      border-radius:50%;
    }
    
    .field input,
    .field select,
    .field textarea{
      width:100%;
      padding:14px 18px;
      border-radius:var(--radius-sm);
      border:1px solid var(--line);
      background:var(--card);
      color:var(--ink);
      font-size:14px;
      transition:all var(--transition-fast);
      backdrop-filter:blur(10px);
    }
    
    .field input:focus,
    .field select:focus,
    .field textarea:focus{
      outline:none;
      border-color:var(--primary);
      background:var(--card-hover);
      box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1);
      transform:translateY(-1px);
    }
    
    .field input:hover,
    .field select:hover,
    .field textarea:hover{
      border-color:var(--line-hover);
      background:var(--card-hover);
    }
    
    /* Компактные поля для настроек */
    .field.compact {
      min-width: 120px;
      max-width: 180px;
    }
    
    .field.compact input,
    .field.compact select {
      padding: 10px 12px;
      font-size: 13px;
    }
    
    /* Строки с полями */
    .row{
      display:flex;
      gap:var(--spacing-lg);
      align-items:flex-end;
      margin-bottom:var(--spacing-lg);
      flex-wrap: wrap;
    }
    
    .row .field{
      flex:1;
      margin-bottom:0;
      min-width: 140px;
    }
    
    /* Адаптивность для строк */
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
        gap: var(--spacing-md);
      }
      
      .row .field {
        margin-bottom: var(--spacing-md);
        min-width: auto;
      }
    }

        /* Современные таблицы */
    .calc-scroll{
      overflow:auto;
      max-height:35vh;
      border:1px solid var(--line);
      border-radius:var(--radius-sm);
      background:var(--card);
      position:relative;
      margin-bottom: var(--spacing-lg);
    }
    
    .calc-scroll::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:1px;
      background:linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity:0.5;
    }
    
    .calc-table{
      min-width:800px;
      border-collapse:separate;
      border-spacing:0;
      width: 100%;
    }
    
    .calc-table th{
      position:sticky;
      top:0;
      background:rgba(15, 20, 32, 0.95);
      backdrop-filter:blur(20px);
      z-index:10;
      padding:16px 12px;
      font-weight:600;
      font-size:13px;
      color:var(--ink);
      border-bottom:2px solid var(--line);
      text-align:center;
      transition:background var(--transition-fast);
    }
    
    .calc-table th:hover{
      background:rgba(15, 20, 32, 0.98);
    }
    
    .calc-table td{
      padding:14px 12px;
      border-bottom:1px solid var(--line);
      text-align:center;
      transition:all var(--transition-fast);
    }
    
    .calc-table tr:hover td{
      background:rgba(255,255,255,0.02);
    }
    
    .calc-table tr:hover td:first-child{
      border-left:3px solid var(--primary);
    }
    
    /* Таблица кэшфлоу */
    .cashflow-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    
    .cashflow-table th {
      background: var(--card-hover);
      border-bottom: 2px solid var(--line);
      border-right: 1px solid var(--line);
      padding: var(--spacing-md);
      font-weight: 600;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .cashflow-table th:last-child {
      border-right: none;
    }
    
    .cashflow-table td {
      border-bottom: 1px solid var(--line);
      border-right: 1px solid var(--line);
      padding: var(--spacing-md);
      text-align: center;
    }
    
    .cashflow-table td:last-child {
      border-right: none;
    }
    
    .cashflow-table tr:last-child td {
      border-bottom: none;
    }
    
    .cashflow-table tbody tr {
      transition: all var(--transition-fast);
      cursor: pointer;
    }
    
    .cashflow-table tbody tr:hover {
      background: var(--card-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary);
    }
    
    .cashflow-table tbody tr:hover td {
      border-color: var(--line-hover);
      color: var(--ink);
    }
    
    .cashflow-table tbody tr:hover td:first-child {
      border-left: 3px solid var(--primary);
      background: linear-gradient(90deg, var(--primary), transparent);
    }
    
    /* Современные модальные окна */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:1000;
      animation:fadeInScale 0.3s ease-out;
    }
    
    .modal{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      max-width:90vw;
      max-height:90vh;
      overflow:hidden;
      box-shadow:var(--shadow-xl);
      animation:fadeInUp 0.4s ease-out 0.1s both;
      position:relative;
    }
    
    .modal::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:3px;
      background:linear-gradient(90deg, var(--primary), var(--accent), var(--success));
    }
    
    .modal-header{
      padding:24px 24px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .modal-header h3{
      margin:0;
      font-size:1.5rem;
      font-weight:600;
      color:var(--ink);
    }
    
    .modal-content{
      padding:24px;
      overflow-y:auto;
      max-height:60vh;
    }
    
    .modal-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      padding-top:20px;
      border-top:1px solid var(--line);
      margin-top:24px;
    }

    /* Современные формы */
    .form-section{
      margin-bottom:24px;
    }
    
    .form-section h4{
      margin:0 0 16px;
      font-size:1.1rem;
      font-weight:600;
      color:var(--ink);
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .form-section h4::before{
      content:'';
      width:3px;
      height:16px;
      background:var(--accent);
      border-radius:2px;
    }
    
    .form-row{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-bottom:16px;
    }
    
    .form-group{
      display:grid;
      gap:6px;
    }
    
    /* Современные KPI блоки */
    .kpi-block{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:16px;
      margin:20px 0;
    }
    
    .kpi-item{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius-sm);
      padding:16px;
      text-align:center;
      transition:all var(--transition-normal);
      position:relative;
      overflow:hidden;
    }
    
    .kpi-item::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:2px;
      background:linear-gradient(90deg, var(--primary), var(--accent));
      transform:scaleX(0);
      transition:transform var(--transition-normal);
    }
    
    .kpi-item:hover{
      background:var(--card-hover);
      border-color:var(--line-hover);
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }
    
    .kpi-item:hover::before{
      transform:scaleX(1);
    }
    
    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
      display:block;
    }
    
    .kpi-value{
      font-size:1.5rem;
      font-weight:700;
      color:var(--ink);
      background:linear-gradient(135deg, var(--ink) 0%, var(--accent) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    /* Дополнительные элементы */
    .pill{
      padding:6px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      font-size:12px;
      color:var(--ink);
    }
    
    .badge{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      padding:4px 8px;
      border-radius:6px;
      font-size:11px;
      color:var(--muted);
    }
    
    .muted{color:var(--muted)}
    
    .hr{
      height:1px;
      background:var(--line);
      border:0;
      margin:var(--spacing-lg) 0;
    }
    
    /* Новые стили для исправлений */
    .calculation-header {
      margin-bottom: var(--spacing-lg);
    }
    
    .stages-scroll {
      min-height: 120px;
      border: 1px dashed #223;
      border-radius: 8px;
      padding: 6px;
      margin-bottom: var(--spacing-lg);
    }
    
    .cashflow-scroll {
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      background: var(--card);
      overflow: visible;
    }
    
    .stages-section h4 {
      margin: 0 0 var(--spacing-md);
      color: var(--ink);
    }
    
    .stage-item {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
    }
    
    .stage-item input {
      flex: 1;
      padding: 8px 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      color: var(--ink);
      font-size: 13px;
    }
    
    .stage-item input[type="number"] {
      max-width: 80px;
      text-align: center;
    }
    
    .stages-info {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      padding: var(--spacing-sm);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      font-size: 13px;
    }
    
    .stages-info.success {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }
    
    .stages-info.warning {
      border-color: var(--warning);
      background: rgba(245, 158, 11, 0.1);
    }
    
    .success-text {
      color: var(--success);
      font-weight: 500;
    }
    
    .warning-text {
      color: var(--warning);
      font-weight: 500;
    }
    
    .share-buttons {
      margin-top: var(--spacing-lg);
    }
    
    .calculation-section h3 {
      margin: 0;
      color: var(--ink);
    }
    
    .cashflow-section h4 {
      margin: 0 0 var(--spacing-md);
      color: var(--ink);
    }
    
    .catalog-section h4 {
      margin: 0 0 var(--spacing-lg);
      color: var(--ink);
    }
    
    .projects-section h5 {
      margin: 0 0 var(--spacing-md);
      color: var(--ink);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }
    
    .project-item {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    
    .project-header {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }
    
    .villas-section h6 {
      margin: 0 0 var(--spacing-sm);
      color: var(--ink);
    }
    
    .villas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }
    
    .villa-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: var(--spacing-sm);
      align-items: center;
      padding: var(--spacing-sm);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-sm);
    }
    
    .villa-item input {
      padding: 6px 8px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      color: var(--ink);
      font-size: 12px;
    }
    
    .catalog-project h4 {
      margin: 0 0 var(--spacing-md);
      color: var(--ink);
    }
    
    .catalog-villa {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-sm);
    }
    
    .villa-info {
      flex: 1;
    }
    
    .villa-name {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .villa-details {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Очень компактная кнопка для добавления из каталога */
    .add-selected-btn {
      padding: 6px 12px;
      font-size: 11px;
      min-width: auto;
      height: 28px;
      line-height: 1;
    }
    
    /* Отступы между кнопками экспорта */
    .export-buttons {
      display: flex;
      gap: var(--spacing-sm);
    }
    
    /* Информационный блок для начального месяца */
    .info-display {
      padding: 10px 12px;
      background: var(--card-hover);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      color: var(--ink);
      font-size: 13px;
      text-align: center;
      font-weight: 500;
    }
    
    /* Красивое поле ввода для названия проекта в каталоге */
    .project-name-input {
      width: 100%;
      padding: 10px 14px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      color: var(--ink);
      font-size: 14px;
      transition: all var(--transition-fast);
      font-weight: 500;
    }
    
    .project-name-input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--card-hover);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }
    
    /* Заголовок и навигация */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--line);
      margin-bottom: var(--spacing-lg);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--spacing-lg) var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--ink);
      margin: 0;
    }
    
    .header-controls {
      display: flex;
      gap: var(--spacing-sm);
    }
    
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-md);
    }
    
    .container {
      width: 100%;
    }
    
    /* Адаптивность */
    @media (max-width: 767px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .kpi-block {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .villa-item {
        grid-template-columns: 1fr;
        gap: var(--spacing-xs);
      }
      
      .project-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .modal-content {
        margin: 20px;
        max-width: calc(100vw - 40px);
      }
    }
    
    @media (max-width: 480px) {
      .field.compact {
        min-width: 100px;
      }
      
      .row {
        flex-direction: column;
      }
      
      .header-content {
        flex-direction: column;
        gap: var(--spacing-md);
      }
    }

      </style>
</head>
<body>
  <div class="wrap">
    <h1 id="app-title">Arconique / Инвестиционный калькулятор</h1>
    <div id="boot-diagnostics" style="position:fixed;left:10px;top:10px;z-index:99999;background:#1b2336;color:#fff;border:1px solid #334;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:80vw;display:none"></div>
    <div id="root"></div>
  </div>

  <!-- libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/chart.js@4/dist/chart.umd.js"></script>
  <script crossorigin src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="text/babel">
    const {useState,useEffect,useRef,useMemo,useCallback}=React;

    // Переводы
    const T={
      ru:{
        title:'Arconique / Инвестиционный калькулятор',
        editor:'Редактор',
        client:'Клиент',
        settings:'Параметры',
        handoverMonth:'Готовность объекта: месяц год',
        globalRate:'Глобальная ставка, %/мес',
        globalTerm:'Глобальный срок post‑handover (6–24 мес)',
        startMonth:'Начальный месяц',
        stagesTitle:'Базовая рассрочка',
        stagesSumPct:'Срок рассрочки',
        months:'мес',
        villasTitle:'Детальный расчет рассрочки объекта недвижмости',
        addFromCatalog:'Добавить из каталога',
        project:'Проект',
        villa:'Вилла',
        area:'Площадь',
        ppsm:'Цена за м²',
        baseUSD:'Базовая стоимость (USD)',
        totalLine:'Итоговая стоимость',
        prePct:'До ключей, %',
        ownTerms:'Свои условия',
        monthlyRatePct:'Ставка, %/мес',
        discountPct:'Скидка, %',
        remove:'Удалить',
        lines:'Позиций',
        keys:'Ключи через',
        cashflowTitle:'Сводный кэшфлоу по месяцам',
        month:'Месяц',
        total:'Итого',
        exportCSV:'Экспорт CSV',
        exportExcel:'Экспорт Excel',
        savePDF:'Сохранить в PDF',
        catalogTitle:'Каталог проектов и вилл (редактор)',
        addProject:'Добавить проект',
        addVilla:'Добавить виллу',
        projectName:'Название проекта',
        villaName:'Название виллы',
        save:'Сохранить',
        cancel:'Отмена',
        addSelected:'Добавить выбранные',
        stagesSum:'Сумма этапов',
        targetPct:'Целевой % до ключей',
        needsChanges:'— внесите изменения',
        matchesTarget:'— соответствует выбранному проценту оплаты до получения ключей'
      },
      en:{
        title:'Arconique / Investment Calculator',
        editor:'Editor',
        client:'Client',
        settings:'Parameters',
        handoverMonth:'Object readiness: month year',
        globalRate:'Global rate, %/month',
        globalTerm:'Global post‑handover term (6–24 months)',
        startMonth:'Start month',
        stagesTitle:'Base installment',
        stagesSumPct:'Installment term',
        months:'months',
        villasTitle:'Detailed installment calculation for real estate object',
        addFromCatalog:'Add from catalog',
        project:'Project',
        villa:'Villa',
        area:'Area',
        ppsm:'Price per m²',
        baseUSD:'Base cost (USD)',
        totalLine:'Total cost',
        prePct:'Before keys, %',
        ownTerms:'Own terms',
        monthlyRatePct:'Rate, %/month',
        discountPct:'Discount, %',
        remove:'Remove',
        lines:'Positions',
        keys:'Keys in',
        cashflowTitle:'Summary cashflow by months',
        month:'Month',
        total:'Total',
        exportCSV:'Export CSV',
        exportExcel:'Export Excel',
        savePDF:'Save as PDF',
        catalogTitle:'Projects and villas catalog (editor)',
        addProject:'Add project',
        addVilla:'Add villa',
        projectName:'Project name',
        villaName:'Villa name',
        save:'Save',
        cancel:'Cancel',
        addSelected:'Add selected',
        stagesSum:'Stages sum',
        targetPct:'Target % before keys',
        needsChanges:'— make changes',
        matchesTarget:'— matches selected payment percentage before receiving keys'
      }
    };

    // Основное приложение
    function App(){
      const [lang,setLang]=useState('ru');
      const [isClient,setIsClient]=useState(false);
      const [startMonth,setStartMonth]=useState(new Date());
      const [handoverMonth,setHandoverMonth]=useState(12);
      const [globalRate,setGlobalRate]=useState(8.33);
      const [globalTerm,setGlobalTerm]=useState(12);
      const [stages,setStages]=useState([
        {id:1,name:'Фундамент',pct:15,month:3},
        {id:2,name:'Стены',pct:25,month:6},
        {id:3,name:'Крыша',pct:20,month:9},
        {id:4,name:'Отделка',pct:29,month:12}
      ]);
      const [lines,setLines]=useState([]);
      const [catalog,setCatalog]=useState([
        {
          projectId:'ahao',
          projectName:'AHAO',
          villas:[
            {villaId:'ahao-2br',name:'2BR Villa',area:120,ppsm:2500,baseUSD:300000},
            {villaId:'ahao-3br',name:'3BR Villa',area:150,ppsm:2500,baseUSD:375000}
          ]
        }
      ]);
      const [modalOpen,setModalOpen]=useState(false);
      const [showAddProjectModal,setShowAddProjectModal]=useState(false);
      const [showAddVillaModal,setShowAddVillaModal]=useState(false);
      const [newProjectForm,setNewProjectForm]=useState({projectId:'',projectName:'',villas:[]});
      const [newVillaForm,setNewVillaForm]=useState({villaId:'',name:'',area:'',ppsm:'',baseUSD:''});
      const [selectedProject,setSelectedProject]=useState('');
      const [currency,setCurrency]=useState('USD');
      const [toCurrency,setToCurrency]=useState(1);

      // Функция форматирования месяца
      const formatMonth = (monthOffset) => {
        const date = new Date(startMonth);
        date.setMonth(date.getMonth() + monthOffset);
        return date.toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'en-US', { 
          month: 'long', 
          year: 'numeric' 
        });
      };

      // Функции для работы с проектами
      const addProject = () => {
        setNewProjectForm({
          projectId: '',
          projectName: '',
          villas: []
        });
        setShowAddProjectModal(true);
      };

      const saveProject = () => {
        if (!newProjectForm.projectId || !newProjectForm.projectName) {
          alert('Заполните ID и название проекта');
          return;
        }
        
        const projectExists = catalog.find(p => p.projectId === newProjectForm.projectId);
        if (projectExists) {
          alert('Проект с таким ID уже существует');
          return;
        }

        const newProject = {
          projectId: newProjectForm.projectId,
          projectName: newProjectForm.projectName,
          villas: []
        };

        setCatalog(prev => [...prev, newProject]);
        setShowAddProjectModal(false);
        setNewProjectForm({projectId: '', projectName: '', villas: []});
      };

      const addVilla = () => {
        if (!selectedProject) {
          alert('Сначала выберите проект');
          return;
        }
        setNewVillaForm({
          villaId: '',
          name: '',
          area: '',
          ppsm: '',
          baseUSD: ''
        });
        setShowAddVillaModal(true);
      };

      const saveVilla = () => {
        if (!newVillaForm.villaId || !newVillaForm.name || !newVillaForm.area || !newVillaForm.ppsm || !newVillaForm.baseUSD) {
          alert('Заполните все поля');
          return;
        }

        const project = catalog.find(p => p.projectId === selectedProject);
        if (!project) return;

        const villaExists = project.villas.find(v => v.villaId === newVillaForm.villaId);
        if (villaExists) {
          alert('Вилла с таким ID уже существует в проекте');
          return;
        }

        const newVilla = {
          villaId: newVillaForm.villaId,
          name: newVillaForm.name,
          area: parseFloat(newVillaForm.area),
          ppsm: parseFloat(newVillaForm.ppsm),
          baseUSD: parseFloat(newVillaForm.baseUSD)
        };

        setCatalog(prev => prev.map(p => 
          p.projectId === selectedProject 
            ? {...p, villas: [...p.villas, newVilla]}
            : p
        ));

        setShowAddVillaModal(false);
        setNewVillaForm({villaId: '', name: '', area: '', ppsm: '', baseUSD: ''});
      };

      // Расчеты
      const stagesSumPct = useMemo(() => stages.reduce((sum,s) => sum + s.pct, 0), [stages]);
      const months = useMemo(() => handoverMonth + globalTerm, [handoverMonth, globalTerm]);

      const project = useMemo(() => {
        if(lines.length === 0) return {totals:{totalUSD:0,totalLocal:0}};
        
        const cashflow = [];
        for(let month = 0; month <= months; month++) {
          let monthTotal = 0;
          lines.forEach(line => {
            if(line.ownTerms) {
              // Свои условия
              if(month < line.months) {
                monthTotal += (line.snapshot.baseUSD * (100 - line.prePct) / 100) / line.months;
              }
            } else {
              // Глобальные условия
              if(month < handoverMonth) {
                // До ключей - по этапам
                const stageMonth = Math.floor(month / handoverMonth * stages.length);
                if(stageMonth < stages.length) {
                  monthTotal += line.snapshot.baseUSD * stages[stageMonth].pct / 100;
                }
              } else {
                // После ключей - рассрочка
                const postHandoverMonth = month - handoverMonth;
                if(postHandoverMonth < globalTerm) {
                  monthTotal += (line.snapshot.baseUSD * (100 - line.prePct) / 100) / globalTerm;
                }
              }
            }
          });
          cashflow.push({month, total: monthTotal});
        }
        
        const totalUSD = lines.reduce((sum, line) => sum + line.snapshot.baseUSD, 0);
        const totalLocal = totalUSD * toCurrency;
        
        return {cashflow, totals: {totalUSD, totalLocal}};
      }, [lines, stages, handoverMonth, globalTerm, months, toCurrency]);

      // Экспорт
      const exportCSV = () => {
        if(project.cashflow) {
          const csv = [
            ['Месяц', 'Сумма'],
            ...project.cashflow.map(c => [formatMonth(c.month), c.total.toFixed(2)])
          ].map(row => row.join(',')).join('\n');
          
          const blob = new Blob([csv], {type: 'text/csv'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'cashflow.csv';
          a.click();
          URL.revokeObjectURL(url);
        }
      };

      const exportExcel = () => {
        if(project.cashflow) {
          const ws = XLSX.utils.aoa_to_sheet([
            ['Месяц', 'Сумма'],
            ...project.cashflow.map(c => [formatMonth(c.month), c.total.toFixed(2)])
          ]);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Cashflow');
          XLSX.writeFile(wb, 'cashflow.xlsx');
        }
      };

      const savePDF = () => {
        if(project.cashflow) {
          const doc = new jsPDF();
          doc.setFontSize(16);
          doc.text('Сводный кэшфлоу по месяцам', 20, 20);
          doc.setFontSize(12);
          project.cashflow.forEach((c, i) => {
            doc.text(`${formatMonth(c.month)}: ${c.total.toFixed(2)}`, 20, 40 + i * 10);
          });
          doc.save('cashflow.pdf');
        }
      };

      // PIN для редактора
      const checkPin = () => {
        const pin = prompt('Введите PIN для входа в редактор:');
        if(pin === '334346') {
          setIsClient(false);
          localStorage.setItem('arconique_v76_editor', 'true');
        } else {
          alert('Неверный PIN');
        }
      };

      useEffect(() => {
        const savedEditor = localStorage.getItem('arconique_v76_editor');
        if(savedEditor === 'true') {
          setIsClient(false);
        }
      }, []);

      const t = T[lang];

      return (
        <div className="app">
          <header className="header">
            <div className="header-content">
              <h1 className="logo">Arconique</h1>
              <div className="header-controls">
                <button className="btn compact" onClick={() => setLang(lang === 'ru' ? 'en' : 'ru')}>
                  {lang === 'ru' ? 'EN' : 'RU'}
                </button>
                {isClient ? (
                  <button className="btn primary" onClick={checkPin}>
                    {t.editor}
                  </button>
                ) : (
                  <button className="btn" onClick={() => {
                    setIsClient(true);
                    localStorage.removeItem('arconique_v76_editor');
                  }}>
                    {t.client}
                  </button>
                )}
              </div>
            </div>
          </header>

          <main className="main">
            <div className="container">
              <div className="grid">
                {/* Левая колонка - Настройки */}
                <div className="card">
                  <h3>{t.settings}</h3>
                  
                  {/* Первая строка: Месяц получения ключей + Глобальная ставка */}
                  <div className="row">
                    <div className="field compact">
                      <label>{t.handoverMonth}</label>
                      <input 
                        type="number" 
                        min="1" 
                        step="1" 
                        value={handoverMonth} 
                        onChange={(e) => setHandoverMonth(parseInt(e.target.value))}
                        disabled={isClient}
                      />
                    </div>
                    <div className="field compact">
                      <label>{t.globalRate}</label>
                      <input 
                        type="number" 
                        min="0.1" 
                        step="0.01" 
                        value={globalRate} 
                        onChange={(e) => setGlobalRate(parseFloat(e.target.value))}
                        disabled={isClient}
                      />
                    </div>
                  </div>

                  {/* Вторая строка: Глобальный срок + Начальный месяц */}
                  <div className="row">
                    <div className="field compact">
                      <label>{t.globalTerm}</label>
                      <input 
                        type="number" 
                        min="6" 
                        max="24" 
                        step="1" 
                        value={globalTerm} 
                        onChange={(e) => setGlobalTerm(parseInt(e.target.value))}
                        disabled={isClient}
                      />
                    </div>
                    <div className="field compact">
                      <label>{t.startMonth}</label>
                      <div className="info-display">
                        {startMonth.toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'en-US', { 
                          month: 'long', 
                          year: 'numeric' 
                        })}
                      </div>
                    </div>
                  </div>

                  {/* Этапы ДО ключей */}
                  <div className="stages-section">
                    <h4>{t.stagesTitle}</h4>
                    <div className="stages-scroll">
                      {stages.map(stage => (
                        <div key={stage.id} className="stage-item">
                          <input 
                            type="text" 
                            value={stage.name} 
                            onChange={(e) => setStages(prev => prev.map(s => 
                              s.id === stage.id ? {...s, name: e.target.value} : s
                            ))}
                            disabled={isClient}
                            placeholder="Название этапа"
                          />
                          <input 
                            type="number" 
                            min="0" 
                            max="100" 
                            step="0.01" 
                            value={stage.pct} 
                            onChange={(e) => setStages(prev => prev.map(s => 
                              s.id === stage.id ? {...s, pct: parseFloat(e.target.value)} : s
                            ))}
                            disabled={isClient}
                            placeholder="%"
                          />
                          <input 
                            type="number" 
                            min="1" 
                            step="1" 
                            value={stage.month} 
                            onChange={(e) => setStages(prev => prev.map(s => 
                              s.id === stage.id ? {...s, month: parseInt(e.target.value)} : s
                            ))}
                            disabled={isClient}
                            placeholder="Месяц"
                          />
                          <button 
                            className="btn danger compact" 
                            onClick={() => setStages(prev => prev.filter(s => s.id !== stage.id))}
                            disabled={isClient}
                          >
                            {t.remove}
                          </button>
                        </div>
                      ))}
                      {!isClient && (
                        <button 
                          className="btn success compact" 
                          onClick={() => setStages(prev => [...prev, {
                            id: Date.now(),
                            name: '',
                            pct: 0,
                            month: 0
                          }]}
                        >
                          + Этап
                        </button>
                      )}
                    </div>
                    
                    {/* Информация о суммах этапов */}
                    <div className={`stages-info ${stagesSumPct === 89 ? 'success' : 'warning'}`}>
                      <span>{t.stagesSum}: {stagesSumPct.toFixed(2)}%</span>
                      <span>·</span>
                      <span>{t.targetPct}: 89%</span>
                      {stagesSumPct === 89 ? (
                        <span className="success-text">{t.matchesTarget}</span>
                      ) : (
                        <span className="warning-text">{t.needsChanges}</span>
                      )}
                    </div>
                  </div>

                  {/* Кнопки поделиться */}
                  <div className="share-buttons">
                    <button className="btn compact" onClick={() => {
                      const url = new URL(window.location);
                      url.searchParams.set('data', btoa(JSON.stringify({stages,lines,handoverMonth,globalRate,globalTerm})));
                      navigator.clipboard.writeText(url.toString());
                      alert('Ссылка скопирована в буфер обмена');
                    }}>
                      Поделиться
                    </button>
                  </div>
                </div>

                                {/* Правая колонка - Расчеты */}
                <div className="card">
                  <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
                    <div className="row">
                      <span className="badge">{t.lines}: {lines.length}</span>
                      <span className="badge">{t.keys} {handoverMonth} мес.</span>
                      {!isClient && <span className="badge">{t.months}: {months}</span>}
                    </div>
                    <div className="muted">{isClient ? t.client : t.editor}</div>
                  </div>

                  {/* Расчет (позиции) */}
                  <div className="calculation-section">
                    <div className="calculation-header" style={{marginBottom: 'var(--spacing-lg)'}}>
                      <h3 style={{margin:'6px 0'}}>{t.villasTitle}</h3>
                      <button className="btn success" onClick={()=>setModalOpen(true)}>{t.addFromCatalog}</button>
                    </div>
                    
                    <div className="calc-scroll">
                      <table className="calc-table">
                        <thead>
                          <tr>
                            <th>{t.project}</th>
                            <th>{t.villa}</th>
                            <th>{t.area}</th>
                            <th>{t.ppsm}</th>
                            <th>{t.baseUSD}</th>
                            <th>{t.totalLine}</th>
                            <th>{t.prePct}</th>
                            <th>{t.ownTerms}</th>
                            <th>{t.stagesSumPct}</th>
                            <th>{t.monthlyRatePct}</th>
                            <th>{t.discountPct}</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                          {lines.map(line => (
                            <tr key={line.id}>
                              <td>{catalog.find(p => p.projectId === line.projectId)?.projectName || line.projectId}</td>
                              <td>{line.snapshot.name}</td>
                              <td>{line.snapshot.area} м²</td>
                              <td>${line.snapshot.ppsm.toLocaleString()}</td>
                              <td>${line.snapshot.baseUSD.toLocaleString()}</td>
                              <td>${(line.snapshot.baseUSD * (1 - line.discountPct / 100)).toLocaleString()}</td>
                              <td>
                                <input 
                                  type="range" 
                                  min="50" 
                                  max="100" 
                                  step="1" 
                                  value={line.prePct} 
                                  onChange={(e) => setLines(prev => prev.map(l => 
                                    l.id === line.id ? {...l, prePct: parseInt(e.target.value)} : l
                                  ))}
                                  disabled={isClient}
                                />
                                {line.prePct}%
                              </td>
                              <td>
                                <input 
                                  type="checkbox" 
                                  checked={line.ownTerms} 
                                  onChange={(e) => setLines(prev => prev.map(l => 
                                    l.id === line.id ? {...l, ownTerms: e.target.checked} : l
                                  ))}
                                  disabled={isClient}
                                />
                              </td>
                              <td>
                                {line.ownTerms ? (
                                  <input 
                                    type="number" 
                                    min="1" 
                                    step="1" 
                                    value={line.months || ''} 
                                    onChange={(e) => setLines(prev => prev.map(l => 
                                      l.id === line.id ? {...l, months: parseInt(e.target.value)} : l
                                    ))}
                                    disabled={isClient}
                                    placeholder="мес"
                                  />
                                ) : (
                                  <span>{stagesSumPct}%</span>
                                )}
                              </td>
                              <td>
                                {line.ownTerms ? (
                                  <input 
                                    type="number" 
                                    min="0.1" 
                                    step="0.01" 
                                    value={line.monthlyRatePct || ''} 
                                    onChange={(e) => setLines(prev => prev.map(l => 
                                      l.id === line.id ? {...l, monthlyRatePct: parseFloat(e.target.value)} : l
                                    ))}
                                    disabled={isClient}
                                    placeholder="%/мес"
                                  />
                                ) : (
                                  <span>{globalRate}%</span>
                                )}
                              </td>
                              <td>
                                <input 
                                  type="number" 
                                  min="0" 
                                  max="50" 
                                  step="0.01" 
                                  value={line.discountPct} 
                                  onChange={(e) => setLines(prev => prev.map(l => 
                                    l.id === line.id ? {...l, discountPct: parseFloat(e.target.value)} : l
                                  ))}
                                  disabled={isClient}
                                  placeholder="%"
                                />
                              </td>
                              <td>
                                {/* Кнопка удаления - теперь доступна в обоих режимах */}
                                <button 
                                  className="btn danger compact" 
                                  onClick={() => setLines(prev => prev.filter(l => l.id !== line.id))}
                                >
                                  {t.remove}
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* Сводный кэшфлоу по месяцам */}
                  <div className="cashflow-section">
                    <h4>{t.cashflowTitle}</h4>
                    <div className="cashflow-scroll">
                      <table className="cashflow-table">
                        <thead>
                          <tr>
                            <th>{t.month}</th>
                            <th>{t.total}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {project.cashflow?.map(c => (
                            <tr key={c.month}>
                              <td>{formatMonth(c.month)}</td>
                              <td>${c.total.toFixed(2)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    
                    {/* Кнопки экспорта */}
                    <div className="export-buttons">
                      <button className="btn compact" onClick={exportCSV}>{t.exportCSV}</button>
                      <button className="btn compact" onClick={exportExcel}>{t.exportExcel}</button>
                      <button className="btn compact" onClick={savePDF}>{t.savePDF}</button>
                    </div>
                  </div>

                  {/* График */}
                  {project.cashflow && (
                    <div className="chart-section">
                      <canvas id="cashflowChart" width="400" height="200"></canvas>
                    </div>
                  )}

                  {/* Каталог проектов и вилл (редактор) */}
                  {!isClient && (
                    <div className="catalog-section">
                      <h4>{t.catalogTitle}</h4>
                      
                      {/* Проекты */}
                      <div className="projects-section">
                        <div className="section-header">
                          <h5>Проекты</h5>
                          <button className="btn success compact" onClick={addProject}>
                            {t.addProject}
                          </button>
                        </div>
                        
                        <div className="projects-list">
                          {catalog.map(project => (
                            <div key={project.projectId} className="project-item">
                              <div className="project-header">
                                <input 
                                  type="text" 
                                  value={project.projectName} 
                                  onChange={(e) => setCatalog(prev => prev.map(p => 
                                    p.projectId === project.projectId ? {...p, projectName: e.target.value} : p
                                  ))}
                                  className="project-name-input"
                                  placeholder="Название проекта"
                                />
                                <button 
                                  className="btn danger compact" 
                                  onClick={() => setCatalog(prev => prev.filter(p => p.projectId !== project.projectId))}
                                >
                                  {t.remove}
                                </button>
                              </div>
                              
                              {/* Виллы в проекте */}
                              <div className="villas-section">
                                <div className="villas-header">
                                  <h6>Виллы</h6>
                                  <button className="btn success compact" onClick={() => {
                                    setSelectedProject(project.projectId);
                                    addVilla();
                                  }}>
                                    {t.addVilla}
                                  </button>
                                </div>
                                
                                <div className="villas-list">
                                  {project.villas.map(villa => (
                                    <div key={villa.villaId} className="villa-item">
                                      <input 
                                        type="text" 
                                        value={villa.name} 
                                        onChange={(e) => setCatalog(prev => prev.map(p => 
                                          p.projectId === project.projectId ? {
                                            ...p, 
                                            villas: p.villas.map(v => 
                                              v.villaId === villa.villaId ? {...v, name: e.target.value} : v
                                            )
                                          } : p
                                        ))}
                                        className="villa-name-input"
                                        placeholder="Название виллы"
                                      />
                                      <input 
                                        type="number" 
                                        value={villa.area} 
                                        onChange={(e) => setCatalog(prev => prev.map(p => 
                                          p.projectId === project.projectId ? {
                                            ...p, 
                                            villas: p.villas.map(v => 
                                              v.villaId === villa.villaId ? {...v, area: parseFloat(e.target.value)} : v
                                            )
                                          } : p
                                        ))}
                                        placeholder="Площадь"
                                      />
                                      <input 
                                        type="number" 
                                        value={villa.ppsm} 
                                        onChange={(e) => setCatalog(prev => prev.map(p => 
                                          p.projectId === project.projectId ? {
                                            ...p, 
                                            villas: p.villas.map(v => 
                                              v.villaId === villa.villaId ? {...v, ppsm: parseFloat(e.target.value)} : v
                                            )
                                          } : p
                                        ))}
                                        placeholder="Цена за м²"
                                      />
                                      <input 
                                        type="number" 
                                        value={villa.baseUSD} 
                                        onChange={(e) => setCatalog(prev => prev.map(p => 
                                          p.projectId === project.projectId ? {
                                            ...p, 
                                            villas: p.villas.map(v => 
                                              v.villaId === villa.villaId ? {...v, baseUSD: parseFloat(e.target.value)} : v
                                            )
                                          } : p
                                        ))}
                                        placeholder="Базовая стоимость"
                                      />
                                      <button 
                                        className="btn danger compact" 
                                        onClick={() => setCatalog(prev => prev.map(p => 
                                          p.projectId === project.projectId ? {
                                            ...p, 
                                            villas: p.villas.filter(v => v.villaId !== villa.villaId)
                                          } : p
                                        ))}
                                      >
                                        {t.remove}
                                      </button>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </main>

                    {/* Модальное окно выбора из каталога */}
          {modalOpen && (
            <div className="modal-overlay" onClick={() => setModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h3>Выберите из каталога</h3>
                  <button className="btn compact" onClick={() => setModalOpen(false)}>✕</button>
                </div>
                <div className="modal-content">
                  {catalog.map(p => (
                    <div key={p.projectId} className="catalog-project">
                      <h4>{p.projectName}</h4>
                      {p.villas.map(v => (
                        <div key={v.villaId} className="catalog-villa">
                          <div className="villa-info">
                            <span className="villa-name">{v.name}</span>
                            <span className="villa-details">
                              {v.area} м² • ${v.ppsm.toLocaleString()}/м² • ${v.baseUSD.toLocaleString()}
                            </span>
                          </div>
                          <button 
                            className="btn success add-selected-btn" 
                            onClick={()=>{
                              const newLine={
                                id:Date.now()+Math.random(),
                                projectId:p.projectId,
                                villaId:v.villaId,
                                qty:1,
                                prePct:stagesSumPct,
                                ownTerms:false,
                                months:null,
                                monthlyRatePct:null,
                                discountPct:0,
                                snapshot:{name:v.name,area:v.area,ppsm:v.ppsm,baseUSD:v.baseUSD}
                              };
                              setLines(prev=>[...prev,newLine]);
                              setModalOpen(false);
                            }}
                          >
                            {t.addSelected}
                          </button>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Модальное окно добавления проекта */}
          {showAddProjectModal && (
            <div className="modal-overlay" onClick={() => setShowAddProjectModal(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h3>{t.addProject}</h3>
                  <button className="btn compact" onClick={() => setShowAddProjectModal(false)}>✕</button>
                </div>
                <div className="modal-content">
                  <div className="field">
                    <label>ID проекта</label>
                    <input 
                      type="text" 
                      value={newProjectForm.projectId} 
                      onChange={(e) => setNewProjectForm(prev => ({...prev, projectId: e.target.value}))}
                      placeholder="Введите ID проекта"
                    />
                  </div>
                  <div className="field">
                    <label>{t.projectName}</label>
                    <input 
                      type="text" 
                      value={newProjectForm.projectName} 
                      onChange={(e) => setNewProjectForm(prev => ({...prev, projectName: e.target.value}))}
                      placeholder="Введите название проекта"
                    />
                  </div>
                  <div className="modal-actions">
                    <button className="btn" onClick={() => setShowAddProjectModal(false)}>{t.cancel}</button>
                    <button className="btn success" onClick={saveProject}>{t.save}</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Модальное окно добавления виллы */}
          {showAddVillaModal && (
            <div className="modal-overlay" onClick={() => setShowAddVillaModal(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h3>{t.addVilla}</h3>
                  <button className="btn compact" onClick={() => setShowAddVillaModal(false)}>✕</button>
                </div>
                <div className="modal-content">
                  <div className="field">
                    <label>ID виллы</label>
                    <input 
                      type="text" 
                      value={newVillaForm.villaId} 
                      onChange={(e) => setNewVillaForm(prev => ({...prev, villaId: e.target.value}))}
                      placeholder="Введите ID виллы"
                    />
                  </div>
                  <div className="field">
                    <label>{t.villaName}</label>
                    <input 
                      type="text" 
                      value={newVillaForm.name} 
                      onChange={(e) => setNewVillaForm(prev => ({...prev, name: e.target.value}))}
                      placeholder="Введите название виллы"
                    />
                  </div>
                  <div className="field">
                    <label>{t.area}</label>
                    <input 
                      type="number" 
                      value={newVillaForm.area} 
                      onChange={(e) => setNewVillaForm(prev => ({...prev, area: e.target.value}))}
                      placeholder="Площадь в м²"
                    />
                  </div>
                  <div className="field">
                    <label>{t.ppsm}</label>
                    <input 
                      type="number" 
                      value={newVillaForm.ppsm} 
                      onChange={(e) => setNewVillaForm(prev => ({...prev, ppsm: e.target.value}))}
                      placeholder="Цена за м²"
                    />
                  </div>
                  <div className="field">
                    <label>{t.baseUSD}</label>
                    <input 
                      type="number" 
                      value={newVillaForm.baseUSD} 
                      onChange={(e) => setNewVillaForm(prev => ({...prev, baseUSD: e.target.value}))}
                      placeholder="Базовая стоимость в USD"
                    />
                  </div>
                  <div className="modal-actions">
                    <button className="btn" onClick={() => setShowAddVillaModal(false)}>{t.cancel}</button>
                    <button className="btn success" onClick={saveVilla}>{t.save}</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Компонент KPI блока
    function KPIBlock({isClient, t, totals, currency, toCurrency}){
      return (
        <div className="kpi-block">
          <div className="kpi-item">
            <span className="kpi-label">Общая стоимость</span>
            <span className="kpi-value">${totals.totalUSD.toLocaleString()}</span>
          </div>
          <div className="kpi-item">
            <span className="kpi-label">В {currency}</span>
            <span className="kpi-value">{(totals.totalUSD * toCurrency).toLocaleString()}</span>
          </div>
        </div>
      );
    }

    // Рендер приложения
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>


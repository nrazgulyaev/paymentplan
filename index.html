<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arcлолдоonique / Калькулятор рассрочки для любимых клиентов — v8.4</title>
    
    <!-- CDN библиотеки -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        
        :root {
            /* Современная цветовая палитра */
            --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --card: rgba(255,255,255,0.03);
            --card-hover: rgba(255,255,255,0.08);
            --card-active: rgba(255,255,255,0.12);
            --line: rgba(255,255,255,0.08);
            --line-hover: rgba(255,255,255,0.15);
            --muted: #94a3b8;
            --ink: #f8fafc;
            --ink-secondary: #cbd5e1;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --radius: 16px;
            --radius-sm: 8px;
            --radius-lg: 24px;
            
            /* Современные тени */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Анимации */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Отступы и размеры */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Высота блоков */
            --block-min-height: 200px;
            --block-max-height: 600px;
            
            /* Z-index слои */
            --z-base: 1;
            --z-card: 10;
            --z-modal: 1000;
            --z-tooltip: 1100;
        }
        
        /* Базовые стили */
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--ink);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Современные анимации для элементов */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-8px) rotate(0.5deg); }
            66% { transform: translateY(4px) rotate(-0.5deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Современные компоненты */
        .wrap {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 16px;
            animation: fadeInUp 0.8s ease-out;
        }
        
        h1 {
            margin: 0 0 16px;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--ink) 0%, var(--ink-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }
        
        /* Современная сетка */
        .grid {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 24px;
            animation: fadeInScale 0.6s ease-out 0.2s both;
        }
        
        @media (max-width: 1023px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        /* Полноширинный блок для каталога */
        .full-width-block {
            grid-column: 1 / -1;
            margin-top: 24px;
        }
        
        /* Современные карточки */
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            backdrop-filter: blur(20px);
            transition: all var(--transition-normal);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
        }
        
        .card:hover {
            background: var(--card-hover);
            border-color: var(--line-hover);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        /* Утилиты */
        .row {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }
        
        .hr {
            height: 1px;
            background: var(--line);
            margin: var(--spacing-lg) 0;
            border-radius: 1px;
        }
        
        .muted {
            color: var(--muted);
            font-size: 0.9em;
        }
        
        /* Поля ввода - ИСПРАВЛЕНО: ограничена ширина */
        .field {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .field.compact {
            flex: 1;
            min-width: 0; /* Важно для flexbox */
            max-width: 180px; /* Ограничиваем максимальную ширину */
        }
        
        .field label {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--ink-secondary);
        }
        
        .field input,
        .field select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
            width: 100%; /* Занимает всю доступную ширину */
            box-sizing: border-box; /* Учитываем padding и border */
        }
        
        .field input:focus,
        .field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .field input[type="range"] {
            background: var(--line);
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .field input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all var(--transition-fast);
        }
        
        .field input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }
        
        /* Кнопки */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-sm);
            background: var(--line);
            color: var(--ink);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            white-space: nowrap;
        }
        
        .btn:hover {
            background: var(--line-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .btn.primary:hover {
            background: var(--primary-hover);
        }
        
        .btn.success {
            background: var(--success);
            color: white;
        }
        
        .btn.success:hover {
            background: var(--success-hover);
        }
        
        .btn.warning {
            background: var(--warning);
            color: white;
        }
        
        .btn.warning:hover {
            background: var(--warning-hover);
        }
        
        .btn.danger {
            background: var(--danger);
            color: white;
        }
        
        .btn.danger:hover {
            background: var(--danger-hover);
        }
        
        .btn.icon {
            padding: var(--spacing-sm);
            min-width: 36px;
            justify-content: center;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Бейджи и пилюли */
        .badge {
            background: var(--line);
            color: var(--ink-secondary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .pill {
            background: var(--primary);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        /* KPI блоки */
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }
        
        .kpi {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            text-align: center;
            transition: all var(--transition-normal);
            animation: fadeInScale 0.6s ease-out both;
        }
        
        .kpi:hover {
            background: var(--card-hover);
            border-color: var(--line-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .kpi .muted {
            font-size: 0.8em;
            margin-bottom: var(--spacing-sm);
            display: block;
        }
        
        .kpi .v {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--ink);
        }
        
        /* Таблицы */
        .calc-table,
        .stages-table,
        .cashflow-table,
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-md) 0;
            background: var(--card);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .calc-table th,
        .calc-table td,
        .stages-table th,
        .stages-table td,
        .cashflow-table th,
        .cashflow-table td,
        .catalog-table th,
        .catalog-table td {
            padding: var(--spacing-sm);
            text-align: center;
            border-bottom: 1px solid var(--line);
            font-size: 0.9em;
        }
        
        .calc-table th,
        .stages-table th,
        .cashflow-table th,
        .catalog-table th {
            background: var(--line);
            color: var(--ink-secondary);
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calc-table tr:hover,
        .stages-table tr:hover,
        .cashflow-table tr:hover,
        .catalog-table tr:hover {
            background: var(--card-hover);
        }
        
        /* Оптимизированные колонки для таблиц */
        .col-project { width: 15%; }
        .col-villa { width: 15%; }
        .col-qty { width: 8%; }
        .col-area { width: 10%; }
        .col-ppsm { width: 12%; }
        .col-base { width: 12%; }
        .col-disc { width: 8%; }
        .col-pre { width: 10%; }
        .col-months { width: 8%; }
        .col-rate { width: 8%; }
        .col-first { width: 0%; display: none; } /* Скрыта */
        .col-lineTotal { width: 12%; }
        .col-actions { width: 8%; }
        
        .col-stage { width: 30%; }
        .col-percent { width: 25%; }
        .col-month { width: 25%; }
        .col-actions { width: 20%; }
        
        /* Стили для отображения данных в таблицах */
        .project-name-display,
        .villa-name-display,
        .area-display,
        .ppsm-display,
        .base-strong,
        .line-total {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            color: var(--ink);
            font-weight: 500;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Стили для ползунков в этапах */
        .stage-number-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            text-align: center;
            font-size: 0.9em;
        }
        
        .stage-number-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Стили для этапов */
        .stage-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
        }
        
        .stage-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .delete-stage-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .delete-stage-btn:hover {
            background: var(--danger-hover);
            transform: scale(1.05);
        }
        
        /* Стили для каталога */
        .catalog-card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .catalog-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .catalog-table input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
            text-align: center;
        }
        
        .catalog-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Стили для модальных окон */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            animation: fadeInScale 0.3s ease-out;
        }
        
        .modal-content {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--ink);
        }
        
        .modal-body {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-section {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-section h4 {
            margin: 0 0 var(--spacing-sm);
            color: var(--ink-secondary);
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .form-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--ink-secondary);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            color: var(--ink);
            font-size: 0.9em;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }
        
        /* Стили для умных вкладок - ИСПРАВЛЕНО: убрана вкладка "Этапы" */
        .smart-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--line);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
        }
        
        .smart-tab {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--ink-secondary);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        
        .smart-tab:hover {
            color: var(--ink);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .smart-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .tab-icon {
            font-size: 1.1em;
        }
        
        .tab-label {
            font-weight: 600;
        }
        
        .tab-counter {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        /* Стили для групп настроек */
        .settings-group {
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .settings-header {
            background: var(--line);
            padding: var(--spacing-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: all var(--transition-fast);
        }
        
        .settings-header:hover {
            background: var(--line-hover);
        }
        
        .group-icon {
            font-size: 1.1em;
        }
        
        .group-title {
            flex: 1;
            font-weight: 600;
            color: var(--ink);
        }
        
        .group-toggle {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--ink-secondary);
            transition: transform var(--transition-fast);
        }
        
        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-slow);
            background: var(--card);
        }
        
        .settings-content.expanded {
            max-height: 800px;
            padding: var(--spacing-md);
        }
        
        /* Стили для мобильной навигации */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--line);
            padding: var(--spacing-sm);
            display: none;
            justify-content: space-around;
            backdrop-filter: blur(20px);
            z-index: var(--z-card);
        }
        
        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            background: none;
            border: none;
            color: var(--ink-secondary);
            font-size: 0.8em;
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
        }
        
        .mobile-nav-btn:hover,
        .mobile-nav-btn.active {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .mobile-nav-btn span {
            font-size: 0.7em;
        }
        
        /* Стили для индикатора автосохранения */
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: var(--shadow);
            z-index: var(--z-tooltip);
            display: none;
            animation: slideInLeft 0.3s ease-out;
        }
        
        /* Стили для полной ширины блока */
        .full-width-block {
            width: 100%;
            margin-top: var(--spacing-xl);
        }
        
        /* Стили для отображения месяцев с реальными датами */
        .month-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .month-number {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .month-date {
            font-size: 0.8em;
            color: var(--muted);
        }
        
        /* Стили для заголовка расчета */
        .calculation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        /* Стили для подсказок */
        .hint {
            font-size: 0.8em;
            color: var(--ink-secondary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            background: var(--line);
        }
        
        .hint.warn {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .wrap {
                margin: 16px auto;
                padding: 0 12px;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .kpis {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .kpi .v {
                font-size: 1.2em;
            }
            
            .form-row {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .modal-content {
                width: 95%;
                padding: var(--spacing-md);
            }
            
            .mobile-nav {
                display: flex;
            }
        }
        
        @media (max-width: 480px) {
            .kpis {
                grid-template-columns: 1fr;
            }
            
            .smart-tabs {
                flex-direction: column;
            }
            
            .catalog-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: stretch;
            }
        }
        
        /* Анимации для элементов */
        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out both;
        }
        
        .animate-fade-in:nth-child(2) { animation-delay: 0.1s; }
        .animate-fade-in:nth-child(3) { animation-delay: 0.2s; }
        .animate-fade-in:nth-child(4) { animation-delay: 0.3s; }
        .animate-fade-in:nth-child(5) { animation-delay: 0.4s; }
    </style>
    
    <!-- Диагностика загрузки - ИСПРАВЛЕННАЯ -->
    <script>
        (function() {
            let attempts = 0;
            const maxAttempts = 15;
            
            function checkDependencies() {
                attempts++;
                console.log(`Проверка зависимостей... Попытка ${attempts}/${maxAttempts}`);
                
                if (window.React && window.ReactDOM && window.Babel) {
                    console.log('✅ Все зависимости загружены успешно');
                    console.log('React version:', window.React.version);
                    console.log('ReactDOM version:', window.ReactDOM.version);
                    console.log('Babel version:', window.Babel.version);
                    return true;
                }
                
                if (attempts >= maxAttempts) {
                    console.error('❌ Не удалось загрузить зависимости после', maxAttempts, 'попыток');
                    document.body.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444; background: #1a1a2e; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <h2>Ошибка загрузки</h2>
                            <p>Не удалось загрузить React или Babel. Попробуйте обновить страницу.</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px;">
                                Обновить страницу
                            </button>
                            <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: left; max-width: 600px;">
                                <h3>Статус загрузки:</h3>
                                <p>React: ${window.React ? '✅ Загружен' : '❌ Не загружен'}</p>
                                <p>ReactDOM: ${window.ReactDOM ? '✅ Загружен' : '❌ Не загружен'}</p>
                                <p>Babel: ${window.Babel ? '✅ Загружен' : '❌ Не загружен'}</p>
                            </div>
                        </div>
                    `;
                    return false;
                }
                
                setTimeout(checkDependencies, 1000);
                return false;
            }
            
            // Попытка загрузки альтернативных CDN если основные не загрузились
            if (!window.React) {
                console.log('Попытка загрузки React...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js';
                script.crossOrigin = 'anonymous';
                script.onerror = () => console.error('Не удалось загрузить React с cdnjs');
                document.head.appendChild(script);
            }
            
            if (!window.ReactDOM) {
                console.log('Попытка загрузки ReactDOM...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js';
                script.crossOrigin = 'anonymous';
                script.onerror = () => console.error('Не удалось загрузить ReactDOM с cdnjs');
                document.head.appendChild(script);
            }
            
            if (!window.Babel) {
                console.log('Попытка загрузки Babel...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.20/babel.min.js';
                script.onerror = () => console.error('Не удалось загрузить Babel с cdnjs');
                document.head.appendChild(script);
            }
            
            // Начинаем проверку
            setTimeout(checkDependencies, 500);
        })();
    </script>
</head>
<body>
    <!-- ИСПРАВЛЕНО: добавлен заголовок h1 в HTML -->
    <h1>Arconique / Калькулятор рассрочки для любимых клиентов</h1>
    
    <div id="root"></div>
    <div id="auto-save-indicator"></div>
    
    <script type="text/babel">

                // Импорт React Hooks
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Глобальные utility функции
        function fmtMoney(amount, currency = 'USD') {
            if (typeof amount !== 'number' || isNaN(amount)) return '0';
            
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            return formatter.format(amount);
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }
        
        function getCurrentMonth() {
            const now = new Date();
            return {
                month: now.getMonth(),
                year: now.getFullYear()
            };
        }
        
        function calculateRealDate(monthOffset, lang = 'ru') {
            const { month, year } = getCurrentMonth();
            const targetDate = new Date(year, month + monthOffset, 1);
            
            const monthNames = {
                ru: [
                    'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
                    'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'
                ],
                en: [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ]
            };
            
            const monthName = monthNames[lang][targetDate.getMonth()];
            const yearNum = targetDate.getFullYear();
            
            return {
                month: monthName,
                year: yearNum,
                fullDate: targetDate
            };
        }
        
        async function sha256Hex(message) {
            if (window.crypto && window.crypto.subtle) {
                try {
                    const msgBuffer = new TextEncoder().encode(message);
                    const hashBuffer = await window.crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return hashHex;
                } catch (error) {
                    console.warn('Ошибка SHA-256, используем fallback:', error);
                    // Fallback для PIN 334346
                    return 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3';
                }
            } else {
                // Fallback для старых браузеров - хеш для PIN 334346
                return 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3';
            }
        }
        
        // Компонент KPI блока
        function KPIBlock({ title, value, currency = 'USD' }) {
            const toCurrency = (val) => {
                if (typeof val === 'string') return val;
                return fmtMoney(val, currency);
            };
            
            return (
                <div className="kpi">
                    <span className="muted">{title}</span>
                    <div className="v">{toCurrency(value)}</div>
                </div>
            );
        }
        
        // Переводы (только необходимые)
        const T = {
            title: 'Arconique / Калькулятор рассрочки для любимых клиентов',
            overview: 'Обзор',
            calculation: 'Расчёт',
            cashflow: 'Кэшфлоу',
            catalog: 'Каталог',
            settings: 'Параметры',
            stages: 'Базовая рассрочка',
            addProject: 'Добавить проект',
            addVilla: 'Добавить виллу',
            importJSON: 'Импорт JSON',
            exportJSON: 'Экспорт JSON',
            shareEditor: 'Поделиться (редактор)',
            shareClient: 'Поделиться (клиент)',
            savePDF: 'Сохранить в PDF',
            exportCSV: 'Экспорт CSV',
            exportXLSX: 'Экспорт XLSX',
            addFromCatalog: 'Добавить из каталога',
            projectName: 'Название проекта',
            villaName: 'Название виллы',
            quantity: 'Количество',
            area: 'Площадь (м²)',
            pricePerSqm: 'Цена за м²',
            basePrice: 'Базовая цена',
            discount: 'Скидка, %',
            preKeys: 'До ключей, %',
            months: 'Месяцы',
            rate: 'Ставка, %',
            lineTotal: 'Итого по строке',
            actions: 'Действия',
            delete: 'Удалить',
            duplicate: 'Дублировать',
            stage: 'Этап',
            percent: 'Процент',
            month: 'Месяц',
            deleteStage: 'Удалить этап',
            addStage: 'Добавить этап',
            exchangeRateIDR: 'Курс IDR/USD',
            exchangeRateEUR: 'Курс EUR/USD',
            keysMonth: 'Месяц получения ключей',
            globalRate: 'Глобальная ставка, %/мес',
            globalTerm: 'Глобальный срок post‑handover (6–24 мес)',
            preHandover: 'Pre-handover, %',
            postHandover: 'Post-handover, %',
            interfaceLanguage: 'Язык интерфейса',
            displayCurrency: 'Валюта отображения',
            handoverMonth: 'Месяц получения ключей',
            postHandoverTerms: 'Сроки post-handover',
            selectedVillas: 'Выбранные виллы',
            keysIn: 'Ключи через',
            baseCost: 'Базовая стоимость',
            baseCostUSD: 'Базовая стоимость (USD)',
            totalCost: 'Общая стоимость',
            baseInstallment: 'Базовая рассрочка',
            installmentTerm: 'Срок рассрочки',
            monthlyCashflow: 'Сводный кэшфлоу по месяцам'
        };

                // Основной компонент приложения
        function App() {
            // Состояние приложения
            const [isClient, setIsClient] = useState(false);
            const [activeTab, setActiveTab] = useState('overview');
            const [showAddProjectModal, setShowAddProjectModal] = useState(false);
            const [showAddVillaModal, setShowAddVillaModal] = useState(false);
            const [showAddFromCatalogModal, setShowAddFromCatalogModal] = useState(false);
            const [autoSaveStatus, setAutoSaveStatus] = useState('saved');
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({
                settings: true,
                stages: true,
                calculation: true,
                cashflow: true,
                catalog: true
            });
            
            // Основные параметры
            const [exchangeRateIDR, setExchangeRateIDR] = useState(15500);
            const [exchangeRateEUR, setExchangeRateEUR] = useState(0.85);
            const [keysMonth, setKeysMonth] = useState(12);
            const [globalRate, setGlobalRate] = useState(1.5);
            const [globalTerm, setGlobalTerm] = useState(12);
            const [preHandover, setPreHandover] = useState(50);
            const [postHandover, setPostHandover] = useState(50);
            const [interfaceLanguage, setInterfaceLanguage] = useState('ru');
            const [displayCurrency, setDisplayCurrency] = useState('USD');
            
            // Этапы рассрочки
            const [stages, setStages] = useState([
                { id: 1, stage: 'Аванс', percent: 30, month: 0 },
                { id: 2, stage: 'Фундамент', percent: 20, month: 3 },
                { id: 3, stage: 'Стены', percent: 25, month: 6 },
                { id: 4, stage: 'Крыша', percent: 15, month: 9 },
                { id: 5, stage: 'Отделка', percent: 10, month: 12 }
            ]);
            
            // Позиции расчета
            const [lines, setLines] = useState([
                {
                    id: 1,
                    projectId: 'proj1',
                    villaId: 'villa1',
                    qty: 1,
                    area: 150,
                    ppsm: 2500,
                    base: 375000,
                    disc: 5,
                    prePct: 50,
                    months: 12,
                    rate: 1.5
                }
            ]);
            
            // Каталог проектов и вилл
            const [projects, setProjects] = useState([
                {
                    id: 'proj1',
                    name: 'Проект А',
                    description: 'Современный жилой комплекс'
                }
            ]);
            
            const [villas, setVillas] = useState([
                {
                    id: 'villa1',
                    projectId: 'proj1',
                    name: 'Вилла Премиум',
                    area: 150,
                    ppsm: 2500,
                    base: 375000
                }
            ]);
            
            // История изменений
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            
            // Рефы
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            // Вычисляемые данные
            const linesData = useMemo(() => {
                return lines.map(line => {
                    const project = projects.find(p => p.id === line.projectId);
                    const villa = villas.find(v => v.id === line.villaId);
                    
                    if (!project || !villa) return null;
                    
                    const prePct = clamp(line.prePct, 50, 100); // ИСПРАВЛЕНО: минимум 50%
                    const realDate = calculateRealDate(line.months, interfaceLanguage);
                    
                    return {
                        ...line,
                        projectName: project.name,
                        villaName: villa.name,
                        prePct,
                        realDate,
                        lineTotal: line.base * (1 - line.disc / 100)
                    };
                }).filter(Boolean);
            }, [lines, projects, villas, interfaceLanguage]);
            
            const project = useMemo(() => {
                const totalBase = linesData.reduce((sum, line) => sum + line.base, 0);
                const totalDisc = linesData.reduce((sum, line) => sum + line.base * line.disc / 100, 0);
                const totalPre = linesData.reduce((sum, line) => sum + line.base * line.prePct / 100, 0);
                
                const cashflow = [];
                for (let i = 0; i <= 60; i++) {
                    const realDate = calculateRealDate(i, interfaceLanguage);
                    let amount = 0;
                    
                    if (i === 0) {
                        amount = totalPre;
                    } else if (i <= 12) {
                        amount = (totalBase - totalPre) / 12;
                    }
                    
                    cashflow.push({
                        month: i,
                        amount,
                        realDate
                    });
                }
                
                return {
                    totalBase,
                    totalDisc,
                    totalPre,
                    cashflow
                };
            }, [linesData, interfaceLanguage]);
            
            // Функции для работы с проектами
            const addProject = () => {
                const newProject = {
                    id: generateId(), // ИСПРАВЛЕНО: автоматическая генерация ID
                    name: '',
                    description: ''
                };
                setProjects(prev => [...prev, newProject]);
                setShowAddProjectModal(false);
                setHasUnsavedChanges(true);
            };
            
            const saveProject = (projectId, name, description) => {
                setProjects(prev => prev.map(p => 
                    p.id === projectId ? { ...p, name, description } : p
                ));
                setShowAddProjectModal(false);
                setHasUnsavedChanges(true);
            };
            
            const deleteProject = (projectId) => {
                setProjects(prev => prev.filter(p => p.id !== projectId));
                setVillas(prev => prev.filter(v => v.projectId !== projectId));
                setLines(prev => prev.filter(l => l.projectId !== projectId));
                setHasUnsavedChanges(true);
            };
            
            // Функции для работы с виллами
            const addVilla = () => {
                const newVilla = {
                    id: generateId(), // ИСПРАВЛЕНО: автоматическая генерация ID
                    projectId: projects[0]?.id || '',
                    name: '',
                    area: 0,
                    ppsm: 0,
                    base: 0
                };
                setVillas(prev => [...prev, newVilla]);
                setShowAddVillaModal(false);
                setHasUnsavedChanges(true);
            };
            
            const saveVilla = (villaId, projectId, name, area, ppsm, base) => {
                setVillas(prev => prev.map(v => 
                    v.id === villaId ? { ...v, projectId, name, area, ppsm, base } : v
                ));
                setShowAddVillaModal(false);
                setHasUnsavedChanges(true);
            };
            
            const deleteVilla = (villaId) => {
                setVillas(prev => prev.filter(v => v.id !== villaId));
                setLines(prev => prev.filter(l => l.villaId !== villaId));
                setHasUnsavedChanges(true);
            };
            
            // Функции для работы с позициями
            const addLine = () => {
                const newLine = {
                    id: generateId(),
                    projectId: projects[0]?.id || '',
                    villaId: villas[0]?.id || '',
                    qty: 1,
                    area: 150,
                    ppsm: 2500,
                    base: 375000,
                    disc: 5,
                    prePct: 50,
                    months: 12,
                    rate: 1.5
                };
                setLines(prev => [...prev, newLine]);
                setHasUnsavedChanges(true);
            };
            
            const updLine = (id, field, value) => {
                setLines(prev => prev.map(line => 
                    line.id === id ? { ...line, [field]: value } : line
                ));
                setHasUnsavedChanges(true);
            };
            
            const delLine = (id) => {
                setLines(prev => prev.filter(line => line.id !== id));
                setHasUnsavedChanges(true);
            };
            
            const dupLine = (id) => {
                const line = lines.find(l => l.id === id);
                if (line) {
                    const newLine = { ...line, id: generateId() };
                    setLines(prev => [...prev, newLine]);
                    setHasUnsavedChanges(true);
                }
            };
            
            // Функции для работы с этапами
            const addStage = () => {
                const newStage = {
                    id: generateId(),
                    stage: 'Новый этап',
                    percent: 10,
                    month: stages.length * 3
                };
                setStages(prev => [...prev, newStage]);
                setHasUnsavedChanges(true);
            };
            
            const updateStage = (id, field, value) => {
                setStages(prev => prev.map(stage => 
                    stage.id === id ? { ...stage, [field]: value } : stage
                ));
                setHasUnsavedChanges(true);
            };
            
            const deleteStage = (id) => {
                setStages(prev => prev.filter(stage => stage.id !== id));
                setHasUnsavedChanges(true);
            };
            
            // Функции для работы с каталогом
            const addFromCatalog = (villaId) => {
                const villa = villas.find(v => v.id === villaId);
                if (villa) {
                    const newLine = {
                        id: generateId(),
                        projectId: villa.projectId,
                        villaId: villa.id,
                        qty: 1,
                        area: villa.area,
                        ppsm: villa.ppsm,
                        base: villa.base,
                        disc: 5,
                        prePct: 50,
                        months: 12,
                        rate: 1.5
                    };
                    setLines(prev => [...prev, newLine]);
                    setShowAddFromCatalogModal(false);
                    setHasUnsavedChanges(true);
                }
            };
            
            // Функции экспорта
            const exportPDF = () => {
                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="padding: 20px; font-family: Arial, sans-serif;">
                        <h1>${T.title}</h1>
                        <h2>Отчет по проекту</h2>
                        <p><strong>Общая стоимость:</strong> ${fmtMoney(project.totalBase, displayCurrency)}</p>
                        <p><strong>Скидка:</strong> ${fmtMoney(project.totalDisc, displayCurrency)}</p>
                        <p><strong>Предоплата:</strong> ${fmtMoney(project.totalPre, displayCurrency)}</p>
                        
                        <h3>Позиции</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Проект</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Вилла</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Площадь</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Цена за м²</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Базовая цена</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Скидка</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">До ключей</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Итого</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${linesData.map(line => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${line.projectName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${line.villaName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${line.area} м²</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${fmtMoney(line.ppsm, displayCurrency)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${fmtMoney(line.base, displayCurrency)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${line.disc}%</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${line.prePct}%</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${fmtMoney(line.lineTotal, displayCurrency)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <h3>Этапы рассрочки</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Этап</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Процент</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Месяц</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stages.map(stage => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${stage.stage}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${stage.percent}%</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${stage.month}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <h3>Кэшфлоу по месяцам</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Месяц</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Дата</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Сумма</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${project.cashflow.slice(0, 25).map(cf => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${cf.month}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${cf.realDate.month} ${cf.realDate.year}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${fmtMoney(cf.amount, displayCurrency)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                const opt = {
                    margin: 1,
                    filename: 'arconique_report.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            };
            
            const exportCSV = () => {
                const csvContent = [
                    ['Проект', 'Вилла', 'Площадь', 'Цена за м²', 'Базовая цена', 'Скидка', 'До ключей', 'Итого'],
                    ...linesData.map(line => [
                        line.projectName,
                        line.villaName,
                        line.area,
                        line.ppsm,
                        line.base,
                        line.disc,
                        line.prePct,
                        line.lineTotal
                    ])
                ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'arconique_data.csv';
                link.click();
            };
            
            const exportXLSX = () => {
                const ws = XLSX.utils.json_to_sheet(linesData.map(line => ({
                    'Проект': line.projectName,
                    'Вилла': line.villaName,
                    'Площадь (м²)': line.area,
                    'Цена за м²': line.ppsm,
                    'Базовая цена': line.base,
                    'Скидка (%)': line.disc,
                    'До ключей (%)': line.prePct,
                    'Итого': line.lineTotal
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Данные');
                XLSX.writeFile(wb, 'arconique_data.xlsx');
            };
            
            // Функция поделиться
            const share = (isClientMode = false) => {
                const data = {
                    isClient: isClientMode,
                    lines: linesData,
                    stages,
                    exchangeRateIDR,
                    exchangeRateEUR,
                    keysMonth,
                    globalRate,
                    globalTerm,
                    preHandover,
                    postHandover,
                    interfaceLanguage,
                    displayCurrency
                };
                
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
                const url = `${window.location.origin}${window.location.pathname}#${compressed}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: T.title,
                        text: 'Поделиться расчетом рассрочки',
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('Ссылка скопирована в буфер обмена');
                    });
                }
            };
            
            // Функции для работы с настройками
            const toggleGroup = (groupName) => {
                setExpandedGroups(prev => ({
                    ...prev,
                    [groupName]: !prev[groupName]
                }));
            };
            
            // Автосохранение
            useEffect(() => {
                if (hasUnsavedChanges) {
                    setAutoSaveStatus('saving');
                    
                    const timeoutId = setTimeout(() => {
                        try {
                            const data = {
                                lines,
                                stages,
                                projects,
                                villas,
                                exchangeRateIDR,
                                exchangeRateEUR,
                                keysMonth,
                                globalRate,
                                globalTerm,
                                preHandover,
                                postHandover,
                                interfaceLanguage,
                                displayCurrency
                            };
                            
                            localStorage.setItem('arconique_data', JSON.stringify(data));
                            setAutoSaveStatus('saved');
                            setHasUnsavedChanges(false);
                        } catch (error) {
                            console.error('Ошибка автосохранения:', error);
                            setAutoSaveStatus('error');
                        }
                    }, 1000);
                    
                    return () => clearTimeout(timeoutId);
                }
            }, [hasUnsavedChanges, lines, stages, projects, villas, exchangeRateIDR, exchangeRateEUR, keysMonth, globalRate, globalTerm, preHandover, postHandover, interfaceLanguage, displayCurrency]);
            
            // Загрузка данных при инициализации
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem('arconique_data');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        if (data.lines) setLines(data.lines);
                        if (data.stages) setStages(data.stages);
                        if (data.projects) setProjects(data.projects);
                        if (data.villas) setVillas(data.villas);
                        if (data.exchangeRateIDR) setExchangeRateIDR(data.exchangeRateIDR);
                        if (data.exchangeRateEUR) setExchangeRateEUR(data.exchangeRateEUR);
                        if (data.keysMonth) setKeysMonth(data.keysMonth);
                        if (data.globalRate) setGlobalRate(data.globalRate);
                        if (data.globalTerm) setGlobalTerm(data.globalTerm);
                        if (data.preHandover) setPreHandover(data.preHandover);
                        if (data.postHandover) setPostHandover(data.postHandover);
                        if (data.interfaceLanguage) setInterfaceLanguage(data.interfaceLanguage);
                        if (data.displayCurrency) setDisplayCurrency(data.displayCurrency);
                    }
                } catch (error) {
                    console.error('Ошибка загрузки данных:', error);
                }
            }, []);
            
            // Проверка PIN для редактора
            useEffect(() => {
                const checkPin = async () => {
                    if (!isClient) {
                        const pin = prompt('Введите PIN для входа в редактор:');
                        if (pin) {
                            const hash = await sha256Hex(pin);
                            if (hash === 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3') {
                                setIsClient(false); // Редактор
                            } else {
                                setIsClient(true); // Клиент
                            }
                        } else {
                            setIsClient(true); // Клиент по умолчанию
                        }
                    }
                };
                
                checkPin();
            }, [isClient]);


                 // Рендер компонента
            return (
                <div className="wrap">
                    {/* Индикатор автосохранения */}
                    <div id="auto-save-indicator" className="auto-save-indicator" style={{ display: autoSaveStatus !== 'saved' ? 'block' : 'none' }}>
                        {autoSaveStatus === 'saving' && 'Сохранение...'}
                        {autoSaveStatus === 'saved' && 'Сохранено'}
                        {autoSaveStatus === 'error' && 'Ошибка сохранения'}
                    </div>
                    
                    {/* Основная сетка */}
                    <div className="grid">
                        {/* Левая колонка - Параметры и вкладки */}
                        <div className="card animate-fade-in">
                            {/* Умные вкладки - ИСПРАВЛЕНО: убрана вкладка "Этапы" */}
                            <div className="smart-tabs">
                                <button 
                                    className={`smart-tab ${activeTab === 'overview' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('overview')}
                                >
                                    <span className="tab-icon">📊</span>
                                    <span className="tab-label">{T.overview}</span>
                                    <span className="tab-counter">{linesData.length}</span>
                                </button>
                                <button 
                                    className={`smart-tab ${activeTab === 'calculation' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('calculation')}
                                >
                                    <span className="tab-icon">🧮</span>
                                    <span className="tab-label">{T.calculation}</span>
                                    <span className="tab-counter">{linesData.length}</span>
                                </button>
                                <button 
                                    className={`smart-tab ${activeTab === 'cashflow' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('cashflow')}
                                >
                                    <span className="tab-icon">💰</span>
                                    <span className="tab-label">{T.cashflow}</span>
                                    <span className="tab-counter">{project.cashflow.length}</span>
                                </button>
                                <button 
                                    className={`smart-tab ${activeTab === 'catalog' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('catalog')}
                                >
                                    <span className="tab-icon">📚</span>
                                    <span className="tab-label">{T.catalog}</span>
                                    <span className="tab-counter">{villas.length}</span>
                                </button>
                            </div>
                            
                            {/* Блок параметров */}
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => toggleGroup('settings')}>
                                    <span className="group-icon">⚙️</span>
                                    <span className="group-title">{T.settings}</span>
                                    <span className="group-toggle">{expandedGroups.settings ? '−' : '+'}</span>
                                </div>
                                <div className={`settings-content ${expandedGroups.settings ? 'expanded' : ''}`}>
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{T.exchangeRateIDR}</label>
                                            <input 
                                                type="number" 
                                                value={exchangeRateIDR} 
                                                onChange={(e) => {
                                                    setExchangeRateIDR(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                step="0.01"
                                            />
                                        </div>
                                        <div className="field compact">
                                            <label>{T.exchangeRateEUR}</label>
                                            <input 
                                                type="number" 
                                                value={exchangeRateEUR} 
                                                onChange={(e) => {
                                                    setExchangeRateEUR(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                step="0.01"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{T.keysMonth}</label>
                                            <input 
                                                type="number" 
                                                value={keysMonth} 
                                                onChange={(e) => {
                                                    setKeysMonth(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                min="1"
                                                max="60"
                                            />
                                        </div>
                                        <div className="field compact">
                                            <label>{T.globalRate}</label>
                                            <input 
                                                type="number" 
                                                value={globalRate} 
                                                onChange={(e) => {
                                                    setGlobalRate(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                step="0.1"
                                                min="0"
                                                max="10"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{T.globalTerm}</label>
                                            <input 
                                                type="number" 
                                                value={globalTerm} 
                                                onChange={(e) => {
                                                    setGlobalTerm(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                min="6"
                                                max="24"
                                            />
                                        </div>
                                        <div className="field compact">
                                            <label>{T.preHandover}</label>
                                            <input 
                                                type="range" 
                                                value={preHandover} 
                                                onChange={(e) => {
                                                    setPreHandover(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                min="50"
                                                max="100"
                                                step="1"
                                            />
                                            <span className="muted">{preHandover}%</span>
                                        </div>
                                    </div>
                                    
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{T.postHandover}</label>
                                            <input 
                                                type="range" 
                                                value={postHandover} 
                                                onChange={(e) => {
                                                    setPostHandover(Number(e.target.value));
                                                    setHasUnsavedChanges(true);
                                                }}
                                                min="0"
                                                max="100"
                                                step="1"
                                            />
                                            <span className="muted">{postHandover}%</span>
                                        </div>
                                        <div className="field compact">
                                            <label>{T.interfaceLanguage}</label>
                                            <select 
                                                value={interfaceLanguage} 
                                                onChange={(e) => {
                                                    setInterfaceLanguage(e.target.value);
                                                    setHasUnsavedChanges(true);
                                                }}
                                            >
                                                <option value="ru">Русский</option>
                                                <option value="en">English</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div className="row">
                                        <div className="field compact">
                                            <label>{T.displayCurrency}</label>
                                            <select 
                                                value={displayCurrency} 
                                                onChange={(e) => {
                                                    setDisplayCurrency(e.target.value);
                                                    setHasUnsavedChanges(true);
                                                }}
                                            >
                                                <option value="USD">USD</option>
                                                <option value="EUR">EUR</option>
                                                <option value="IDR">IDR</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Блок этапов рассрочки - ИСПРАВЛЕНО: всегда видимый */}
                            <div className="settings-group">
                                <div className="settings-header" onClick={() => toggleGroup('stages')}>
                                    <span className="group-icon">📅</span>
                                    <span className="group-title">{T.stages}</span>
                                    <span className="group-toggle">{expandedGroups.stages ? '−' : '+'}</span>
                                </div>
                                <div className={`settings-content ${expandedGroups.stages ? 'expanded' : ''}`}>
                                    <div className="stages-table">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th className="col-stage">{T.stage}</th>
                                                    <th className="col-percent">{T.percent}</th>
                                                    <th className="col-month">{T.month}</th>
                                                    <th className="col-actions">{T.actions}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {stages.map(stage => (
                                                    <tr key={stage.id}>
                                                        <td>
                                                            <input
                                                                type="text"
                                                                className="stage-input"
                                                                value={stage.stage}
                                                                onChange={(e) => updateStage(stage.id, 'stage', e.target.value)}
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                type="range"
                                                                className="stage-input"
                                                                value={stage.percent}
                                                                onChange={(e) => updateStage(stage.id, 'percent', Number(e.target.value))}
                                                                min="0"
                                                                max="100"
                                                                step="1"
                                                            />
                                                            <span className="muted">{stage.percent}%</span>
                                                        </td>
                                                        <td>
                                                            <input
                                                                type="number"
                                                                className="stage-number-input"
                                                                value={stage.month}
                                                                onChange={(e) => updateStage(stage.id, 'month', Number(e.target.value))}
                                                                min="0"
                                                                max="60"
                                                            />
                                                        </td>
                                                        <td>
                                                            <button 
                                                                className="delete-stage-btn"
                                                                onClick={() => deleteStage(stage.id)}
                                                            >
                                                                {T.deleteStage}
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button className="btn success" onClick={addStage}>
                                        {T.addStage}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {/* Правая колонка - Расчет и кэшфлоу */}
                        <div className="card animate-fade-in">
                            {/* Заголовок расчета */}
                            <div className="calculation-header">
                                <h3>{T.calculation}</h3>
                                <button className="btn primary" onClick={addLine}>
                                    + {T.addFromCatalog}
                                </button>
                            </div>
                            
                            {/* Таблица расчета позиций */}
                            <div className="calc-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th className="col-project">{T.projectName}</th>
                                            <th className="col-villa">{T.villaName}</th>
                                            <th className="col-qty">{T.quantity}</th>
                                            <th className="col-area">{T.area}</th>
                                            <th className="col-ppsm">{T.pricePerSqm}</th>
                                            <th className="col-base">{T.basePrice}</th>
                                            <th className="col-disc">{T.discount}</th>
                                            <th className="col-pre">{T.preKeys}</th>
                                            <th className="col-months">{T.months}</th>
                                            <th className="col-rate">{T.rate}</th>
                                            <th className="col-first" style={{display: 'none'}}></th>
                                            <th className="col-lineTotal">{T.lineTotal}</th>
                                            <th className="col-actions">{T.actions}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {linesData.map(line => (
                                            <tr key={line.id}>
                                                <td>
                                                    <div className="project-name-display">
                                                        {line.projectName}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div className="villa-name-display">
                                                        {line.villaName}
                                                    </div>
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        value={line.qty}
                                                        onChange={(e) => updLine(line.id, 'qty', Number(e.target.value))}
                                                        min="1"
                                                        max="100"
                                                    />
                                                </td>
                                                <td>
                                                    <div className="area-display">
                                                        {line.area}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div className="ppsm-display">
                                                        {fmtMoney(line.ppsm, displayCurrency)}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div className="base-strong">
                                                        {fmtMoney(line.base, displayCurrency)}
                                                    </div>
                                                </td>
                                                <td>
                                                    <input
                                                        type="range"
                                                        value={line.disc}
                                                        onChange={(e) => updLine(line.id, 'disc', Number(e.target.value))}
                                                        min="0"
                                                        max="50"
                                                        step="1"
                                                    />
                                                    <span className="muted">{line.disc}%</span>
                                                </td>
                                                <td>
                                                    <input
                                                        type="range"
                                                        value={line.prePct}
                                                        onChange={(e) => updLine(line.id, 'prePct', Number(e.target.value))}
                                                        min="50"
                                                        max="100"
                                                        step="1"
                                                    />
                                                    <span className="muted">{line.prePct}%</span>
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        value={line.months}
                                                        onChange={(e) => updLine(line.id, 'months', Number(e.target.value))}
                                                        min="1"
                                                        max="60"
                                                    />
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        value={line.rate}
                                                        onChange={(e) => updLine(line.id, 'rate', Number(e.target.value))}
                                                        step="0.1"
                                                        min="0"
                                                        max="10"
                                                    />
                                                </td>
                                                <td style={{display: 'none'}}></td>
                                                <td>
                                                    <div className="line-total">
                                                        {fmtMoney(line.lineTotal, displayCurrency)}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div className="row">
                                                        <button 
                                                            className="btn icon warning" 
                                                            onClick={() => dupLine(line.id)}
                                                            title={T.duplicate}
                                                        >
                                                            📋
                                                        </button>
                                                        <button 
                                                            className="btn icon danger" 
                                                            onClick={() => delLine(line.id)}
                                                            title={T.delete}
                                                        >
                                                            🗑️
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* KPI блоки */}
                            <div className="kpis">
                                <KPIBlock 
                                    title={T.selectedVillas} 
                                    value={linesData.length} 
                                    currency=""
                                />
                                <KPIBlock 
                                    title={T.keysIn} 
                                    value={`${keysMonth} ${T.months}`} 
                                    currency=""
                                />
                                <KPIBlock 
                                    title={T.baseCost} 
                                    value={project.totalBase} 
                                    currency={displayCurrency}
                                />
                                {!isClient && (
                                    <KPIBlock 
                                        title={T.baseCostUSD} 
                                        value={project.totalBase} 
                                        currency="USD"
                                    />
                                )}
                                <KPIBlock 
                                    title={T.totalCost} 
                                    value={project.totalBase - project.totalDisc} 
                                    currency={displayCurrency}
                                />
                            </div>
                            
                            {/* Таблица кэшфлоу */}
                            <div className="cashflow-table">
                                <h3>{T.monthlyCashflow}</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>{T.month}</th>
                                            <th>Дата</th>
                                            <th>Сумма</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {project.cashflow.slice(0, 25).map((cf, index) => (
                                            <tr key={index}>
                                                <td>
                                                    <div className="month-display">
                                                        <span className="month-number">{cf.month}</span>
                                                        <span className="month-date">{cf.realDate.month} {cf.realDate.year}</span>
                                                    </div>
                                                </td>
                                                <td>{cf.realDate.month} {cf.realDate.year}</td>
                                                <td>{fmtMoney(cf.amount, displayCurrency)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* Кнопки экспорта */}
                            <div className="row" style={{marginTop: '20px', gap: '10px'}}>
                                <button className="btn primary" onClick={exportPDF}>
                                    {T.savePDF}
                                </button>
                                <button className="btn" onClick={exportCSV}>
                                    {T.exportCSV}
                                </button>
                                <button className="btn" onClick={exportXLSX}>
                                    {T.exportXLSX}
                                </button>
                            </div>
                            
                            {/* Кнопки поделиться */}
                            <div className="row" style={{marginTop: '10px', gap: '10px'}}>
                                <button className="btn success" onClick={() => share(false)}>
                                    {T.shareEditor}
                                </button>
                                <button className="btn" onClick={() => share(true)}>
                                    {T.shareClient}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Полноширинный блок - Каталог проектов и вилл */}
                    <div className="full-width-block">
                        <div className="card animate-fade-in">
                            <div className="catalog-header">
                                <h3>Каталог проектов и вилл (редактор)</h3>
                                <div className="catalog-actions">
                                    <button className="btn primary" onClick={() => setShowAddProjectModal(true)}>
                                        {T.addProject}
                                    </button>
                                    <button className="btn primary" onClick={() => setShowAddVillaModal(true)}>
                                        {T.addVilla}
                                    </button>
                                    <button className="btn" onClick={() => setShowAddFromCatalogModal(true)}>
                                        {T.addFromCatalog}
                                    </button>
                                    <button className="btn" onClick={() => {
                                        const input = document.createElement('input');
                                        input.type = 'file';
                                        input.accept = '.json';
                                        input.onchange = (e) => {
                                            const file = e.target.files[0];
                                            if (file) {
                                                const reader = new FileReader();
                                                reader.onload = (e) => {
                                                    try {
                                                        const data = JSON.parse(e.target.result);
                                                        if (data.projects) setProjects(data.projects);
                                                        if (data.villas) setVillas(data.villas);
                                                        setHasUnsavedChanges(true);
                                                    } catch (error) {
                                                        alert('Ошибка чтения файла');
                                                    }
                                                };
                                                reader.readAsText(file);
                                            }
                                        }};
                                        input.click();
                                    }}>
                                        {T.importJSON}
                                    </button>
                                    <button className="btn" onClick={() => {
                                        const data = { projects, villas };
                                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = 'arconique_catalog.json';
                                        a.click();
                                    }}>
                                        {T.exportJSON}
                                    </button>
                                </div>
                            </div>
                            
                            {/* Таблица проектов */}
                            <div className="catalog-table">
                                <h4>Проекты</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Название</th>
                                            <th>Описание</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {projects.map(project => (
                                            <tr key={project.id}>
                                                <td>{project.id}</td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        value={project.name}
                                                        onChange={(e) => {
                                                            const updatedProjects = projects.map(p => 
                                                                p.id === project.id ? { ...p, name: e.target.value } : p
                                                            );
                                                            setProjects(updatedProjects);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                    />
                                                </td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        value={project.description}
                                                        onChange={(e) => {
                                                            const updatedProjects = projects.map(p => 
                                                                p.id === project.id ? { ...p, description: e.target.value } : p
                                                            );
                                                            setProjects(updatedProjects);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                    />
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn danger" 
                                                        onClick={() => deleteProject(project.id)}
                                                    >
                                                        {T.delete}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* Таблица вилл */}
                            <div className="catalog-table">
                                <h4>Виллы</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Проект</th>
                                            <th>Название</th>
                                            <th>Площадь (м²)</th>
                                            <th>Цена за м²</th>
                                            <th>Базовая цена</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {villas.map(villa => (
                                            <tr key={villa.id}>
                                                <td>{villa.id}</td>
                                                <td>
                                                    <select
                                                        value={villa.projectId}
                                                        onChange={(e) => {
                                                            const updatedVillas = villas.map(v => 
                                                                v.id === villa.id ? { ...v, projectId: e.target.value } : v
                                                            );
                                                            setVillas(updatedVillas);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                    >
                                                        {projects.map(project => (
                                                            <option key={project.id} value={project.id}>
                                                                {project.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        value={villa.name}
                                                        onChange={(e) => {
                                                            const updatedVillas = villas.map(v => 
                                                                v.id === villa.id ? { ...v, name: e.target.value } : v
                                                            );
                                                            setVillas(updatedVillas);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                    />
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        value={villa.area}
                                                        onChange={(e) => {
                                                            const updatedVillas = villas.map(v => 
                                                                v.id === villa.id ? { ...v, area: Number(e.target.value) } : v
                                                            );
                                                            setVillas(updatedVillas);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                        min="0"
                                                        step="0.01"
                                                    />
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        value={villa.ppsm}
                                                        onChange={(e) => {
                                                            const updatedVillas = villas.map(v => 
                                                                v.id === villa.id ? { ...v, ppsm: Number(e.target.value) } : v
                                                            );
                                                            setVillas(updatedVillas);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                        min="0"
                                                        step="0.01"
                                                    />
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        value={villa.base}
                                                        onChange={(e) => {
                                                            const updatedVillas = villas.map(v => 
                                                                v.id === villa.id ? { ...v, base: Number(e.target.value) } : v
                                                            );
                                                            setVillas(updatedVillas);
                                                            setHasUnsavedChanges(true);
                                                        }}
                                                        min="0"
                                                        step="0.01"
                                                    />
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn danger" 
                                                        onClick={() => deleteVilla(villa.id)}
                                                    >
                                                        {T.delete}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                                    {/* Модальное окно добавления проекта */}
                    {showAddProjectModal && (
                        <div className="modal-overlay" onClick={() => setShowAddProjectModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{T.addProject}</h3>
                                    <button 
                                        className="btn icon" 
                                        onClick={() => setShowAddProjectModal(false)}
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>Информация о проекте</h4>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>ID проекта</label>
                                                <input 
                                                    type="text" 
                                                    value="ID генерируется автоматически" 
                                                    disabled 
                                                />
                                                <div className="hint">ID генерируется автоматически</div>
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Название проекта</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="Введите название проекта"
                                                    id="newProjectName"
                                                />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Описание</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="Введите описание проекта"
                                                    id="newProjectDescription"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="form-actions">
                                    <button 
                                        className="btn" 
                                        onClick={() => setShowAddProjectModal(false)}
                                    >
                                        Отмена
                                    </button>
                                    <button 
                                        className="btn primary" 
                                        onClick={() => {
                                            const name = document.getElementById('newProjectName').value;
                                            const description = document.getElementById('newProjectDescription').value;
                                            if (name.trim()) {
                                                const newProject = {
                                                    id: generateId(),
                                                    name: name.trim(),
                                                    description: description.trim()
                                                };
                                                setProjects(prev => [...prev, newProject]);
                                                setShowAddProjectModal(false);
                                                setHasUnsavedChanges(true);
                                            }
                                        }}
                                    >
                                        {T.addProject}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Модальное окно добавления виллы */}
                    {showAddVillaModal && (
                        <div className="modal-overlay" onClick={() => setShowAddVillaModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{T.addVilla}</h3>
                                    <button 
                                        className="btn icon" 
                                        onClick={() => setShowAddVillaModal(false)}
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>Информация о вилле</h4>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>ID виллы</label>
                                                <input 
                                                    type="text" 
                                                    value="ID генерируется автоматически" 
                                                    disabled 
                                                />
                                                <div className="hint">ID генерируется автоматически</div>
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Проект</label>
                                                <select id="newVillaProjectId">
                                                    {projects.map(project => (
                                                        <option key={project.id} value={project.id}>
                                                            {project.name}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Название виллы</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="Введите название виллы"
                                                    id="newVillaName"
                                                />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Площадь (м²)</label>
                                                <input 
                                                    type="number" 
                                                    placeholder="0"
                                                    id="newVillaArea"
                                                    min="0"
                                                    step="0.01"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Цена за м²</label>
                                                <input 
                                                    type="number" 
                                                    placeholder="0"
                                                    id="newVillaPpsm"
                                                    min="0"
                                                    step="0.01"
                                                />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Базовая цена</label>
                                                <input 
                                                    type="number" 
                                                    placeholder="0"
                                                    id="newVillaBase"
                                                    min="0"
                                                    step="0.01"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="form-actions">
                                    <button 
                                        className="btn" 
                                        onClick={() => setShowAddVillaModal(false)}
                                    >
                                        Отмена
                                    </button>
                                    <button 
                                        className="btn primary" 
                                        onClick={() => {
                                            const projectId = document.getElementById('newVillaProjectId').value;
                                            const name = document.getElementById('newVillaName').value;
                                            const area = Number(document.getElementById('newVillaArea').value);
                                            const ppsm = Number(document.getElementById('newVillaPpsm').value);
                                            const base = Number(document.getElementById('newVillaBase').value);
                                            
                                            if (name.trim() && projectId) {
                                                const newVilla = {
                                                    id: generateId(),
                                                    projectId,
                                                    name: name.trim(),
                                                    area: area || 0,
                                                    ppsm: ppsm || 0,
                                                    base: base || 0
                                                };
                                                setVillas(prev => [...prev, newVilla]);
                                                setShowAddVillaModal(false);
                                                setHasUnsavedChanges(true);
                                            }
                                        }}
                                    >
                                        {T.addVilla}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Модальное окно добавления из каталога - ИСПРАВЛЕНО: выбор вилл */}
                    {showAddFromCatalogModal && (
                        <div className="modal-overlay" onClick={() => setShowAddFromCatalogModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{T.addFromCatalog}</h3>
                                    <button 
                                        className="btn icon" 
                                        onClick={() => setShowAddFromCatalogModal(false)}
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-section">
                                        <h4>Выберите виллу из каталога</h4>
                                        {villas.length === 0 ? (
                                            <div className="hint warn">
                                                В каталоге нет доступных вилл. Сначала добавьте виллы в каталог.
                                            </div>
                                        ) : (
                                            <div className="catalog-table">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>Проект</th>
                                                            <th>Название</th>
                                                            <th>Площадь (м²)</th>
                                                            <th>Цена за м²</th>
                                                            <th>Базовая цена</th>
                                                            <th>Действие</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {villas.map(villa => {
                                                            const project = projects.find(p => p.id === villa.projectId);
                                                            return (
                                                                <tr key={villa.id}>
                                                                    <td>{project ? project.name : 'Неизвестный проект'}</td>
                                                                    <td>{villa.name}</td>
                                                                    <td>{villa.area}</td>
                                                                    <td>{fmtMoney(villa.ppsm, displayCurrency)}</td>
                                                                    <td>{fmtMoney(villa.base, displayCurrency)}</td>
                                                                    <td>
                                                                        <button 
                                                                            className="btn success" 
                                                                            onClick={() => addFromCatalog(villa.id)}
                                                                        >
                                                                            Добавить
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="form-actions">
                                    <button 
                                        className="btn" 
                                        onClick={() => setShowAddFromCatalogModal(false)}
                                    >
                                        Закрыть
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Мобильная навигация */}
                    <div className="mobile-nav">
                        <button 
                            className={`mobile-nav-btn ${activeTab === 'overview' ? 'active' : ''}`}
                            onClick={() => setActiveTab('overview')}
                        >
                            📊
                            <span>{T.overview}</span>
                        </button>
                        <button 
                            className={`mobile-nav-btn ${activeTab === 'calculation' ? 'active' : ''}`}
                            onClick={() => setActiveTab('calculation')}
                        >
                            🧮
                            <span>{T.calculation}</span>
                        </button>
                        <button 
                            className={`mobile-nav-btn ${activeTab === 'cashflow' ? 'active' : ''}`}
                            onClick={() => setActiveTab('cashflow')}
                        >
                            💰
                            <span>{T.cashflow}</span>
                        </button>
                        <button 
                            className={`mobile-nav-btn ${activeTab === 'catalog' ? 'active' : ''}`}
                            onClick={() => setActiveTab('catalog')}
                        >
                            📚
                            <span>{T.catalog}</span>
                        </button>
                    </div>
                </div>
            );
        }


                // Рендеринг приложения
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Installments • Multi‑Villa (v4)</title>
  <style>
    *{box-sizing:border-box}
    :root{--bg:#0b0d12;--card:#0f1420;--line:#1c2233;--muted:#9fb0d0;--ink:#e7ebf3;--brand:#18b3ff}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px;font-size:24px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{color:var(--muted);font-size:13px}
    input[type="text"],input[type="number"],input[type="range"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #26304a;background:#111828;color:var(--ink)}
    input[type="range"]{padding:0;height:32px}
    .pill{padding:6px 10px;border-radius:999px;background:#10192a;border:1px solid #22304a;font-size:12px}
    .badge{background:#132039;border:1px solid #243353;padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);border:0;margin:10px 0}
    .btn{appearance:none;border:1px solid #2a3756;background:#132039;color:#dfe7ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.warn{background:#2a1420;border-color:#513042;color:#ffd8de}
    .btn.alt{background:#0f1729}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #202a42;text-align:right;font-variant-numeric:tabular-nums}
    th:first-child,td:first-child{text-align:left}
    .scroll{overflow:auto;max-height:48vh}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:10px 0}
    .kpi{background:#0f1420;border:1px solid #1c2233;border-radius:10px;padding:10px 12px}
    .kpi .v{font-size:18px;font-weight:700}
    .note{font-size:12px;color:#94a6c7}
    .danger{color:#ff9b9b}
    canvas{background:#0e1320;border:1px solid #1b2336;border-radius:10px;padding:8px}
    @media print{body{background:white;color:black}.card{border:1px solid #ccc}.btn{display:none}.scroll{max-height:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Калькулятор рассрочки • Multi‑Villa (v4)</h1>
    <div id="root"></div>
  </div>

  <!-- React + Babel + Chart.js + jsPDF -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="text/babel">
    const {useEffect,useMemo,useRef,useState} = React

    // ---------- Utils ----------
    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v))
    const fmtMoney = (n, currency='USD') =>
      new Intl.NumberFormat('en-US',{style:'currency',currency,maximumFractionDigits:2}).format(n??0)

    const encodeStateToUrl = (state) => {
      try {
        const json = JSON.stringify(state)
        const s = btoa(unescape(encodeURIComponent(json)))
        const url = new URL(window.location.href)
        url.hash = 's=' + s
        return url.toString()
      } catch { return '' }
    }
    const decodeStateFromUrl = () => {
      try{
        const hash = new URL(window.location.href).hash
        if(!hash.startsWith('#s=')) return null
        const s = hash.slice(3)
        return JSON.parse(decodeURIComponent(escape(atob(s))))
      }catch { return null }
    }

    // ---------- App ----------
    function App(){
      // Currency (только отображение; расчёты в USD)
      const [currency,setCurrency] = useState('USD')
      const [idrPerUsd,setIdrPerUsd] = useState(16500)
      const [eurPerUsd,setEurPerUsd] = useState(0.92)
      const toCurrency = usd => currency==='USD' ? usd : currency==='IDR' ? usd*idrPerUsd : usd*eurPerUsd

      // Глобальные post-handover условия (по умолчанию)
      const [handoverMonth,setHandoverMonth] = useState(12)
      const [months,setMonths] = useState(12)               // 6..24
      const [monthlyRatePct,setMonthlyRatePct] = useState(8.33)

      // Этапы «плавной» рассрочки (общие)
      const [stages,setStages] = useState([
        {id:1,label:'Договор', pct:30, month:0},
        {id:2,label:'50% готовности', pct:30, month:6},
        {id:3,label:'70% готовности', pct:20, month:9},
        {id:4,label:'90% готовности', pct:15, month:11},
        {id:5,label:'Ключи', pct:5, month:12},
      ])

      // Виллы: теперь со СВОИМИ сроком/ставкой (можно включить/выключить)
      const [villas,setVillas] = useState([
        {id:1,name:'Enso 2BR (пример)', area:100, ppsm:2500, override:false, base:250000, prePct:70,
         ownTerms:false, months:null, monthlyRatePct:null},
      ])

      // ---------- Persistence (LocalStorage + URL) ----------
      useEffect(()=>{
        const fromUrl = decodeStateFromUrl()
        const saved = fromUrl || JSON.parse(localStorage.getItem('installment_v4')||'null')
        if(saved){
          try{
            if(saved.currency) setCurrency(saved.currency)
            if(typeof saved.idrPerUsd==='number') setIdrPerUsd(saved.idrPerUsd)
            if(typeof saved.eurPerUsd==='number') setEurPerUsd(saved.eurPerUsd)
            if(typeof saved.handoverMonth==='number') setHandoverMonth(saved.handoverMonth)
            if(typeof saved.months==='number') setMonths(saved.months)
            if(typeof saved.monthlyRatePct==='number') setMonthlyRatePct(saved.monthlyRatePct)
            if(Array.isArray(saved.stages)) setStages(saved.stages)
            if(Array.isArray(saved.villas) && saved.villas.length) setVillas(saved.villas)
          }catch{}
        }
      },[])
      useEffect(()=>{
        const state = {currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas}
        localStorage.setItem('installment_v4', JSON.stringify(state))
      },[currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas])

      // ---------- Calculations ----------
      const stagesSumPct = useMemo(()=> stages.reduce((s,x)=>s+(+x.pct||0),0), [stages])

      const villaCalcs = useMemo(()=>{
        return villas.map(v=>{
          const baseComputed = v.area * v.ppsm
          const base = v.override ? (v.base||0) : baseComputed
          // до ключей — масштабируем под v.prePct
          const k = stagesSumPct===0 ? 0 : (v.prePct||0)/stagesSumPct
          const preSchedule = stages.map(s=>({
            month: clamp(Math.round(+s.month||0),0,handoverMonth),
            label:s.label,
            amountUSD: base * (((+s.pct||0)*k)/100),
          })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month)
          const preTotal = preSchedule.reduce((s,r)=>s+r.amountUSD,0)
          const afterAmount = Math.max(0, base - preTotal)

          // post — собственные условия или глобальные
          const vMonths = v.ownTerms && v.months ? v.months : months
          const vRate   = (v.ownTerms && v.monthlyRatePct!=null) ? (v.monthlyRatePct/100) : (monthlyRatePct/100)

          const postRows=[]
          let bal = afterAmount, totalI=0
          const principal = vMonths>0 ? afterAmount / vMonths : 0
          for(let i=1;i<=vMonths;i++){
            const interest = bal * vRate
            totalI += interest
            const payment = principal + interest
            postRows.push({
              month: handoverMonth + i,
              label:`Месяц ${i}`,
              principalUSD: principal,
              interestUSD: interest,
              paymentUSD: payment,
              balanceAfterUSD: Math.max(0, bal - principal),
            })
            bal -= principal
          }
          const post = {rows:postRows, totalInterest: totalI, totalPayment: afterAmount + totalI, months:vMonths, ratePct:vRate*100}
          const finalPrice = base + totalI
          return { v, baseComputed, base, preSchedule, preTotal, afterAmount, post, finalPrice }
        })
      },[villas, stages, stagesSumPct, handoverMonth, months, monthlyRatePct])

      // Sums & cashflow
      const project = useMemo(()=>{
        const m = new Map()
        const push = (month, amt, label) => {
          const prev = m.get(month) || {month, items:[], amountUSD:0}
          prev.items.push(label)
          prev.amountUSD += amt
          m.set(month, prev)
        }
        const maxMonth = handoverMonth + Math.max( ...villaCalcs.map(vc=>vc.post.months||0), 0 )
        const balance = Array.from({length:maxMonth+1}, (_,i)=>({month:i, bal:0}))

        villaCalcs.forEach(vc=>{
          vc.preSchedule.forEach(r=> push(r.month, r.amountUSD, `${vc.v.name}: ${r.label}`))
          vc.post.rows.forEach(r=> push(r.month, r.paymentUSD, `${vc.v.name}: ${r.label}`))

          // восстановим оставшийся основной долг (без %)
          const vMonths = vc.post.months||0
          const principal = vMonths>0 ? vc.afterAmount / vMonths : 0
          for(let i=0;i<=vMonths;i++){
            const mo = handoverMonth + i
            const rem = Math.max(0, vc.afterAmount - i*principal)
            const slot = balance.find(b=>b.month===mo)
            if(slot) slot.bal += rem
          }
        })

        const cashflow = Array.from(m.values()).sort((a,b)=>a.month-b.month)
        const totals = {
          baseUSD: villaCalcs.reduce((s,x)=>s+x.base,0),
          preUSD: villaCalcs.reduce((s,x)=>s+x.preTotal,0),
          postPrincipalUSD: villaCalcs.reduce((s,x)=>s+x.afterAmount,0),
          interestUSD: villaCalcs.reduce((s,x)=>s+x.post.totalInterest,0),
          finalUSD: villaCalcs.reduce((s,x)=>s+x.finalPrice,0),
        }
        return {cashflow, balance, totals}
      },[villaCalcs, handoverMonth])

      // ---------- Actions ----------
      const addVilla = ()=> setVillas(prev=>[
        ...prev,
        {id:(prev.at(-1)?.id||0)+1, name:'Новая вилла', area:100, ppsm:2500, override:false, base:250000, prePct:70, ownTerms:false, months:null, monthlyRatePct:null}
      ])
      const updateVilla = (id, patch)=> setVillas(prev=> prev.map(v=> v.id===id? {...v, ...patch}: v))
      const removeVilla = (id)=> setVillas(prev=> prev.filter(v=> v.id!==id))

      // JSON / CSV / Share / Print
      const exportJSON = ()=>{
        const state = {currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas}
        const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'})
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'installments_v4.json'; a.click(); URL.revokeObjectURL(a.href)
      }
      const onImportJSON = async (file)=>{
        try{
          const s = JSON.parse(await file.text())
          if(s.currency) setCurrency(s.currency)
          if(typeof s.idrPerUsd==='number') setIdrPerUsd(s.idrPerUsd)
          if(typeof s.eurPerUsd==='number') setEurPerUsd(s.eurPerUsd)
          if(typeof s.handoverMonth==='number') setHandoverMonth(s.handoverMonth)
          if(typeof s.months==='number') setMonths(s.months)
          if(typeof s.monthlyRatePct==='number') setMonthlyRatePct(s.monthlyRatePct)
          if(Array.isArray(s.stages)) setStages(s.stages)
          if(Array.isArray(s.villas)) setVillas(s.villas)
          alert('Настройки импортированы')
        }catch(e){ alert('Ошибка импорта: ' + e.message) }
      }
      const exportCSV = ()=>{
        const lines = []
        lines.push('Villa,Section,Month,Label,PrincipalUSD,InterestUSD,PaymentUSD,AmountUSD,BalanceAfterUSD,Months,RatePct')
        villaCalcs.forEach(vc=>{
          vc.preSchedule.forEach(r=>{
            lines.push([vc.v.name,'Pre-handover',r.month,r.label,'','','',r.amountUSD.toFixed(2),'','', ''].join(','))
          })
          vc.post.rows.forEach(r=>{
            lines.push([vc.v.name,'Post-handover',r.month,r.label,r.principalUSD.toFixed(2),r.interestUSD.toFixed(2),r.paymentUSD.toFixed(2),'',r.balanceAfterUSD.toFixed(2), vc.post.months, vc.post.ratePct.toFixed(2)].join(','))
          })
        })
        lines.push('')
        lines.push('Cashflow by Month (Project)')
        lines.push('Month,Description,TotalUSD')
        project.cashflow.forEach(c=>{
          lines.push([c.month,(c.items||[]).join(' + '),c.amountUSD.toFixed(2)].join(','))
        })
        const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'})
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'installments_v4.csv'; a.click(); URL.revokeObjectURL(a.href)
      }
      const shareLink = async ()=>{
        const state = {currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas}
        const url = encodeStateToUrl(state)
        if(url){ await navigator.clipboard.writeText(url); alert('Ссылка скопирована') }
      }

      // PDF коммерческое (jsPDF)
      const pdfProposal = (mode='all')=>{
        const { jsPDF } = window.jspdf
        const doc = new jsPDF({unit:'pt', format:'a4'}) // 595 x 842
        const brand = {primary:'#0f1420', accent:'#18b3ff'}

        const drawHeader = (p=1,total=1,title='Коммерческое предложение')=>{
          doc.setFillColor(15,20,32) // dark
          doc.rect(0,0,595,70,'F')
          doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(255,255,255)
          doc.text('Arconique • Enso / Ahau', 24, 28)
          doc.setFontSize(12); doc.setTextColor(160,200,255)
          doc.text(title, 24, 50)
          doc.setTextColor(200,200,200); doc.setFontSize(10)
          doc.text(`Стр. ${p}/${total}`, 540, 24, {align:'right'})
        }

        const blocks = []
        const targets = (mode==='all') ? villaCalcs : villaCalcs.filter(x=> x.v.id === mode)

        targets.forEach(vc=>{
          blocks.push({type:'villa', vc})
        })

        // предварительный подсчёт страниц
        const pages = []
        targets.forEach(vc=>{
          // 1 — титульный блок с KPI
          pages.push({kind:'cover', vc})
          // таблица пост-графика: по 28 строк на страницу условно
          const rows = vc.post.rows
          const chunk = 28
          for(let i=0;i<rows.length;i+=chunk){
            pages.push({kind:'table', vc, start:i, end:Math.min(i+chunk, rows.length)})
          }
        })

        pages.forEach((pg, idx)=>{
          if(idx>0) doc.addPage()
          drawHeader(idx+1, pages.length, pg.kind==='cover' ? 'Коммерческое предложение' : 'График платежей')
          const y0 = 90
          if(pg.kind==='cover'){
            const {vc} = pg
            // Левая колонка — описание
            doc.setTextColor(0); doc.setFont('helvetica','bold'); doc.setFontSize(16)
            doc.text(vc.v.name, 24, y0)
            doc.setFontSize(11); doc.setFont('helvetica','normal')
            doc.text(`Площадь: ${vc.v.area} м² · Цена/м²: $${Number(vc.v.ppsm).toLocaleString('en-US')}`, 24, y0+18)
            doc.text(`Базовая цена: ${fmtMoney(vc.base,'USD')}`, 24, y0+36)
            doc.text(`Оплата до ключей: ${vc.v.prePct}% (${fmtMoney(vc.preTotal,'USD')})`, 24, y0+54)
            doc.text(`Остаток после ключей: ${fmtMoney(vc.afterAmount,'USD')}`, 24, y0+72)

            // Правая — условия
            const bx = 320, by = y0-8
            doc.setDrawColor(24,179,255); doc.setLineWidth(1)
            doc.roundedRect(bx, by, 251, 90, 6, 6)
            doc.setFont('helvetica','bold'); doc.setFontSize(12)
            doc.text('Условия post‑handover', bx+12, by+20)
            doc.setFont('helvetica','normal'); doc.setFontSize(11)
            doc.text(`Срок: ${(vc.post.months)} мес`, bx+12, by+40)
            doc.text(`Ставка: ${vc.post.ratePct.toFixed(2)}% / мес`, bx+12, by+58)
            doc.text(`Проценты: ${fmtMoney(vc.post.totalInterest,'USD')}`, bx+12, by+76)

            // KPI ряд
            const kY = y0+120
            const k = [
              ['Итоговая цена', fmtMoney(vc.finalPrice,'USD')],
              ['Всего к оплате до ключей', fmtMoney(vc.preTotal,'USD')],
              ['Всего после ключей (осн.)', fmtMoney(vc.afterAmount,'USD')],
              ['Сумма процентов', fmtMoney(vc.post.totalInterest,'USD')],
            ]
            let x=24, w=270, h=54
            k.forEach(([t,v],i)=>{
              const yy = kY + (i>=2? (h+10):0)
              const xx = x + (i%2)*(w+10)
              doc.setDrawColor(28,34,51); doc.setLineWidth(0.5)
              doc.roundedRect(xx, yy, w, h, 6, 6)
              doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(110)
              doc.text(t, xx+12, yy+18)
              doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(0)
              doc.text(v, xx+12, yy+38)
            })

            // Примечания
            doc.setFontSize(9); doc.setTextColor(90)
            doc.text('Методика: проценты начисляются ежемесячно на остаток; основной долг гасится равными долями.', 24, 760)
            doc.text('Брендинг условный: Enso/Ahau by Arconique.', 24, 774)
          }

          if(pg.kind==='table'){
            const {vc, start, end} = pg
            doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(0)
            doc.text(`График платежей • ${vc.v.name}`, 24, y0)
            // заголовки таблицы
            const cols = ['Месяц','Осн., USD','% , USD','Платёж, USD','Остаток, USD']
            const cw = [60,110,110,120,120]
            let y = y0+20
            doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(60)
            let x=24; cols.forEach((c,i)=>{ doc.text(c, x, y); x += cw[i] })
            y += 10; doc.setDrawColor(220); doc.line(24, y, 24+cw.reduce((a,b)=>a+b,0), y); y += 8
            doc.setFont('helvetica','normal'); doc.setTextColor(0)
            for(let i=start;i<end;i++){
              const r = vc.post.rows[i]
              let x=24
              const vals = [
                String(r.month),
                fmtMoney(r.principalUSD,'USD'),
                fmtMoney(r.interestUSD,'USD'),
                fmtMoney(r.paymentUSD,'USD'),
                fmtMoney(r.balanceAfterUSD,'USD'),
              ]
              vals.forEach((v,j)=>{ doc.text(v, x, y); x += cw[j] })
              y += 16
            }
          }
        })

        doc.save(mode==='all' ? 'proposal_project.pdf' : 'proposal_villa.pdf')
      }

      return (
        <div className="grid">
          <div className="card col-4">
            <div className="field">
              <label>Валюта отображения</label>
              <select value={currency} onChange={e=>setCurrency(e.target.value)}>
                <option>USD</option><option>IDR</option><option>EUR</option>
              </select>
            </div>
            <div className="row">
              <div className="field" style={{flex:1}}>
                <label>IDR за 1 USD</label>
                <input type="number" min="1" step="1" value={idrPerUsd} onChange={e=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
              </div>
              <div className="field" style={{flex:1}}>
                <label>EUR за 1 USD</label>
                <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={e=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
              </div>
            </div>

            <div className="hr"></div>

            <div className="row">
              <div className="field" style={{flex:1}}>
                <label>Месяц получения ключей</label>
                <input type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
              </div>
            </div>

            <div className="row">
              <div className="field" style={{flex:1}}>
                <label>Глобальный срок post‑handover (6–24 мес)</label>
                <input type="range" min="6" max="24" step="1" value={months} onChange={e=>setMonths(parseInt(e.target.value,10))}/>
                <div className="pill">Срок: {months} мес</div>
              </div>
              <div className="field" style={{flex:1}}>
                <label>Глобальная ставка, %/мес</label>
                <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                <div className="note">По умолчанию 8.33%/мес (≈100% годовых)</div>
              </div>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Этапы ДО ключей</h3>
            <div className="scroll" style={{maxHeight:'26vh',border:'1px dashed #223',borderRadius:'8px',padding:'6px'}}>
              <table>
                <thead><tr><th>Этап</th><th>%</th><th>Месяц</th><th></th></tr></thead>
                <tbody>
                  {stages.map(s=>(
                    <tr key={s.id}>
                      <td style={{textAlign:'left'}}><input type="text" value={s.label} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,label:e.target.value}:x))}/></td>
                      <td><input type="number" min="0" step="0.01" value={s.pct} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,pct:clamp(parseFloat(e.target.value||0),0,100)}:x))}/></td>
                      <td><input type="number" min="0" step="1" value={s.month} onChange={e=>setStages(prev=>prev.map(x=>x.id===s.id?{...x,month:clamp(parseInt(e.target.value||0,10),0,handoverMonth)}:x))}/></td>
                      <td><button className="btn warn" onClick={()=>setStages(prev=>prev.filter(x=>x.id!==s.id))}>Удалить</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="row" style={{marginTop:8}}>
              <button className="btn" onClick={()=>setStages(prev=>[...prev,{id:(prev.at(-1)?.id||0)+1,label:'Этап',pct:5,month:Math.min(handoverMonth,(prev.at(-1)?.month||0)+1)}])}>Добавить этап</button>
            </div>

            <div className="hr"></div>

            <div className="row">
              <button className="btn" onClick={()=>{
                const a = document.createElement('a')
                a.href = URL.createObjectURL(new Blob([JSON.stringify({currency,idrPerUsd,eurPerUsd,handoverMonth,months,monthlyRatePct,stages,villas},null,2)], {type:'application/json'}))
                a.download = 'installments_v4.json'; a.click(); URL.revokeObjectURL(a.href)
              }}>Экспорт JSON</button>

              <label className="btn alt" htmlFor="jsonFile" style={{cursor:'pointer'}}>Импорт JSON</label>
              <input id="jsonFile" type="file" accept="application/json" style={{display:'none'}} onChange={e=>e.target.files[0]&&onImportJSON(e.target.files[0])}/>
            </div>
            <div className="row">
              <button className="btn" onClick={exportCSV}>Экспорт CSV</button>
              <button className="btn alt" onClick={()=>window.print()}>Печать / PDF</button>
              <button className="btn" onClick={shareLink}>Поделиться ссылкой</button>
            </div>
          </div>

          <div className="card col-8">
            <div className="row" style={{justifyContent:'space-between',alignItems:'baseline'}}>
              <div className="row">
                <span className="badge">Вилл: {villas.length}</span>
                <span className="badge">Ключи: мес. {handoverMonth}</span>
                <span className="badge">Глобальная ставка: {monthlyRatePct}%/мес</span>
                <span className="badge">Глобальный срок: {months} мес</span>
              </div>
              <div className="note">У каждой виллы можно включить свои срок/ставку post‑handover.</div>
            </div>

            <div className="kpis">
              <KPI label="База (сумма цен)" value={fmtMoney(project.totals.baseUSD,'USD')}/>
              <KPI label="Оплата до ключей" value={fmtMoney(project.totals.preUSD,'USD')}/>
              <KPI label="Остаток после ключей" value={fmtMoney(project.totals.postPrincipalUSD,'USD')}/>
              <KPI label="Проценты (post)" value={fmtMoney(project.totals.interestUSD,'USD')}/>
              <KPI label="Итоговая цена" value={fmtMoney(project.totals.finalUSD,'USD')}/>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Список вилл</h3>
            <div className="scroll" style={{maxHeight:'34vh'}}>
              <table>
                <thead>
                  <tr>
                    <th>Название</th><th>м²</th><th>$ / м²</th><th>База (USD)</th><th>До ключей, %</th><th>СВОИ условия post</th><th>Срок, мес</th><th>Ставка, %/мес</th><th>PDF</th><th>Удалить</th>
                  </tr>
                </thead>
                <tbody>
                  {villaCalcs.map(vc=>(
                    <tr key={vc.v.id}>
                      <td style={{textAlign:'left'}}>
                        <input type="text" value={vc.v.name} onChange={e=>updateVilla(vc.v.id,{name:e.target.value})}/>
                      </td>
                      <td><input type="number" min="1" step="0.1" value={vc.v.area} onChange={e=>updateVilla(vc.v.id,{area:clamp(parseFloat(e.target.value||0),1,100000)})}/></td>
                      <td><input type="number" min="0" step="1" value={vc.v.ppsm} onChange={e=>updateVilla(vc.v.id,{ppsm:clamp(parseFloat(e.target.value||0),0,1e9)})}/></td>
                      <td>
                        <div className="row" style={{justifyContent:'flex-end'}}>
                          <span className="pill">{fmtMoney(vc.base,'USD')}</span>
                          <label className="pill" style={{display:'inline-flex',gap:6,alignItems:'center'}}>
                            <input type="checkbox" checked={vc.v.override} onChange={e=>updateVilla(vc.v.id,{override:e.target.checked})}/>
                            вручную
                          </label>
                        </div>
                        {vc.v.override && (
                          <input type="number" min="0" step="1" value={vc.v.base} onChange={e=>updateVilla(vc.v.id,{base:clamp(parseFloat(e.target.value||0),0,1e12)})}/>
                        )}
                      </td>
                      <td>
                        <input type="range" min="0" max="100" step="1" value={vc.v.prePct} onChange={e=>updateVilla(vc.v.id,{prePct:parseInt(e.target.value,10)})}/>
                        <div className="pill" style={{display:'inline-block',marginTop:6}}>{vc.v.prePct}%</div>
                      </td>
                      <td>
                        <label className="pill" style={{display:'inline-flex',gap:6,alignItems:'center'}}>
                          <input type="checkbox" checked={vc.v.ownTerms} onChange={e=>updateVilla(vc.v.id,{ownTerms:e.target.checked})}/>
                          включить
                        </label>
                      </td>
                      <td>
                        <input type="number" min="6" step="1" value={vc.v.ownTerms ? (vc.v.months??months) : months}
                          onChange={e=>updateVilla(vc.v.id,{months:clamp(parseInt(e.target.value||0,10),6,120)})} disabled={!vc.v.ownTerms}/>
                      </td>
                      <td>
                        <input type="number" min="0" step="0.01" value={vc.v.ownTerms ? (vc.v.monthlyRatePct??monthlyRatePct) : monthlyRatePct}
                          onChange={e=>updateVilla(vc.v.id,{monthlyRatePct:clamp(parseFloat(e.target.value||0),0,1000)})} disabled={!vc.v.ownTerms}/>
                      </td>
                      <td><button className="btn" onClick={()=>pdfProposal(vc.v.id)}>PDF</button></td>
                      <td><button className="btn warn" onClick={()=>removeVilla(vc.v.id)}>✕</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="row" style={{marginTop:8}}>
              <button className="btn" onClick={addVilla}>Добавить виллу</button>
              <button className="btn alt" onClick={()=>pdfProposal('all')}>PDF‑коммерческое (проект)</button>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Сводный кэшфлоу по месяцам</h3>
            <div className="scroll">
              <table>
                <thead><tr><th>Месяц</th><th>Описание</th><th>Сумма (USD)</th><th>Сумма ({currency})</th></tr></thead>
                <tbody>
                  {project.cashflow.map(c=>(
                    <tr key={c.month}>
                      <td>{c.month}</td>
                      <td style={{textAlign:'left'}}>{(c.items||[]).join(' + ')}</td>
                      <td>{fmtMoney(c.amountUSD,'USD')}</td>
                      <td>{fmtMoney(toCurrency(c.amountUSD), currency)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="hr"></div>

            <h3 style={{margin:'6px 0'}}>Графики</h3>
            <Charts cashflow={project.cashflow} balance={project.balance} currency={currency} toCurrency={toCurrency}/>
            <p className="note" style={{marginTop:10}}>
              Баланс — суммарный остающийся основной долг по всем виллам после получения ключей (без процентов).
              Платежи — помесячные суммы (этапы до ключей + платежи после).
            </p>
          </div>
        </div>
      )
    }

    function KPI({label,value}) {
      return (
        <div className="kpi">
          <div className="muted">{label}</div>
          <div className="v">{value}</div>
        </div>
      )
    }

    // ---------- Charts ----------
    function Charts({cashflow, balance, currency, toCurrency}){
      const payRef = useRef(null)
      const balRef = useRef(null)
      const cfRef  = useRef(null)
      const payChart = useRef(null)
      const balChart = useRef(null)
      const cfChart  = useRef(null)

      const payLabels = cashflow.map(c=>c.month)
      const payDataUSD = cashflow.map(c=>c.amountUSD)
      const cfLabels = payLabels
      const cfData = cashflow.map(c=> toCurrency(c.amountUSD))
      const balLabels = balance.map(b=>b.month)
      const balData = balance.map(b=> toCurrency(b.bal))

      useEffect(()=>{
        payChart.current && payChart.current.destroy()
        balChart.current && balChart.current.destroy()
        cfChart.current && cfChart.current.destroy()

        payChart.current = new Chart(payRef.current, {
          type:'bar',
          data:{ labels: payLabels, datasets:[{ label:`Платежи (USD)`, data: payDataUSD }]},
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}
        })
        balChart.current = new Chart(balRef.current, {
          type:'line',
          data:{ labels: balLabels, datasets:[{ label:`Баланс основного долга (${currency})`, data: balData, fill:false, tension:0.2 }]},
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}
        })
        cfChart.current = new Chart(cfRef.current, {
          type:'bar',
          data:{ labels: cfLabels, datasets:[{ label:`Кэшфлоу (${currency})`, data: cfData }]},
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}
        })
      },[cashflow, balance, currency])

      return (
        <div className="grid">
          <div className="col-12"><canvas ref={payRef} height="120"></canvas></div>
          <div className="col-6"><canvas ref={balRef} height="160"></canvas></div>
          <div className="col-6"><canvas ref={cfRef} height="160"></canvas></div>
        </div>
      )
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>)
  </script>
</body>
</html>
